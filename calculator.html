<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculateur de classification DESP 2014/68/UE pour équipements sous pression">
    <title>Calculateur DESP 2014/68/UE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --color-primary: #0D9488;
            --color-primary-dark: #0F766E;
            --color-primary-light: #F0FDFA;
            --color-accent: #111827;
            --color-accent-dark: #1F2937;
            --color-success: #0D9488;
            --color-warning: #D97706;
            --color-error: #DC2626;
            --color-info: #6B7280;
            --color-orange: #F97316;
            --color-gray-50: #F9FAFB;
            --color-gray-100: #F3F4F6;
            --color-gray-200: #E5E7EB;
            --color-gray-300: #D1D5DB;
            --color-gray-400: #9CA3AF;
            --color-gray-500: #6B7280;
            --color-gray-700: #374151;
            --color-gray-900: #111827;
            --bg-page: #F3F4F6;
            --bg-surface: #FFFFFF;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.05), 0 2px 4px rgba(0,0,0,0.03);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.05), 0 4px 6px rgba(0,0,0,0.03);
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
            --transition-fast: 150ms ease;
            --transition-base: 150ms ease;
            --ring-primary: 0 0 0 3px rgba(13, 148, 136, 0.15);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            font-weight: 400;
            line-height: 1.5;
            color: var(--color-gray-900);
            background: var(--bg-page);
            overflow-x: hidden;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 0;
            color: var(--color-gray-500);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color var(--transition-base);
        }
        .back-link:hover {
            color: var(--color-primary);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-10) var(--space-4);
        }
        .header {
            text-align: center;
            margin-bottom: var(--space-10);
        }
        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--space-2);
            color: var(--color-gray-900);
        }
        .header p {
            font-size: 16px;
            color: var(--color-gray-500);
        }
        .stepper {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }
        .stepper-items {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        .stepper-items::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: var(--color-gray-200);
            z-index: 0;
        }
        .stepper-progress {
            position: absolute;
            top: 20px;
            left: 40px;
            height: 2px;
            background: var(--color-primary);
            transition: width var(--transition-base);
            z-index: 1;
        }
        .stepper-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        .stepper-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-surface);
            border: 2px solid var(--color-gray-300);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-gray-500);
            transition: all var(--transition-base);
            margin-bottom: var(--space-2);
            font-size: 14px;
        }
        .stepper-item.active .stepper-circle {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
            box-shadow: var(--ring-primary);
        }
        .stepper-item.completed .stepper-circle {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }
        .stepper-label {
            font-size: 13px;
            color: var(--color-gray-500);
            text-align: center;
            font-weight: 500;
        }
        .stepper-item.active .stepper-label {
            color: var(--color-gray-900);
            font-weight: 600;
        }
        .card {
            background: var(--bg-surface);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            padding: 0;
            margin-bottom: var(--space-6);
            transition: box-shadow var(--transition-base);
        }
        .card-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--color-gray-100);
        }
        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: var(--space-2);
            color: var(--color-gray-900);
        }
        .card-subtitle {
            font-size: 14px;
            color: var(--color-gray-500);
        }
        .card-body {
            padding: var(--space-6);
        }
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-4);
        }
        .option-card {
            background: var(--bg-surface);
            border: 2px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
        }
        .option-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-lg);
        }
        .option-card.selected {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
            box-shadow: var(--ring-primary);
        }
        .icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }
        .icon-sm {
            width: 16px;
            height: 16px;
        }
        .group-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .group-indicator.danger {
            background-color: var(--color-error);
        }
        .group-indicator.safe {
            background-color: var(--color-success);
        }
        .option-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--space-2);
            color: var(--color-gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .option-description {
            font-size: 13px;
            color: var(--color-gray-500);
            line-height: 1.5;
        }
        .input-group {
            margin-bottom: var(--space-5);
        }
        .input-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-700);
            margin-bottom: 6px;
        }
        .input-wrapper {
            position: relative;
        }
        .input-field {
            width: 100%;
            height: 40px;
            padding: 10px 80px 10px 12px;
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all var(--transition-base);
            background: var(--bg-surface);
            color: var(--color-gray-900);
            font-variant-numeric: tabular-nums;
        }
        .input-field:hover {
            border-color: var(--color-gray-500);
        }
        .input-field:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--ring-primary);
        }
        .input-field.error {
            border-color: var(--color-error);
            background: #FEE2E2;
        }
        .input-unit {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-gray-500);
            font-weight: 600;
            pointer-events: none;
            font-size: 13px;
        }
        .input-helper {
            font-size: 12px;
            color: var(--color-gray-500);
            margin-top: 4px;
        }
        .input-error {
            font-size: 12px;
            color: var(--color-error);
            margin-top: 4px;
            display: none;
        }
        .input-error.visible {
            display: block;
        }
        .info-box {
            background: var(--color-gray-100);
            border-left: 4px solid var(--color-gray-300);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin: var(--space-5) 0;
        }
        .info-box-title {
            font-weight: 600;
            margin-bottom: var(--space-2);
            color: var(--color-gray-700);
            font-size: 14px;
        }
        .info-box-text {
            font-size: 13px;
            color: var(--color-gray-500);
            line-height: 1.5;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-height: 44px;
        }
        .btn-primary {
            background: var(--color-accent);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        .btn-primary:hover {
            background: var(--color-accent-dark);
        }
        .btn-primary:active {
            background: var(--color-gray-700);
            transform: scale(0.98);
        }
        .btn-secondary {
            background: var(--bg-surface);
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-300);
        }
        .btn-secondary:hover {
            background: var(--color-gray-50);
        }
        .btn-group {
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
            margin-top: var(--space-6);
        }
        .checkbox-group {
            margin: var(--space-5) 0;
        }
        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: var(--space-4);
            background: var(--color-gray-50);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
            cursor: pointer;
            transition: all var(--transition-base);
            border: 1px solid transparent;
        }
        .checkbox-item:hover {
            background: var(--bg-surface);
            border-color: var(--color-gray-200);
            box-shadow: var(--shadow-sm);
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: var(--space-4);
            margin-top: 2px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }
        .checkbox-label {
            flex: 1;
        }
        .checkbox-title {
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-2);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-description {
            font-size: 13px;
            color: var(--color-gray-500);
        }
        .result-card {
            padding: var(--space-8);
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: var(--space-6);
            border: 3px solid;
            background: var(--bg-surface);
        }
        .result-art43 { border-color: var(--color-info); }
        .result-art43 .result-title { color: var(--color-info); }
        .result-cat1 { border-color: var(--color-success); }
        .result-cat1 .result-title { color: var(--color-success); }
        .result-cat2 { border-color: var(--color-warning); }
        .result-cat2 .result-title { color: var(--color-warning); }
        .result-cat3 { border-color: var(--color-orange); }
        .result-cat3 .result-title { color: var(--color-orange); }
        .result-cat4 { border-color: var(--color-error); }
        .result-cat4 .result-title { color: var(--color-error); }
        .result-error { border-color: var(--color-error); }
        .result-error .result-title { color: var(--color-error); }
        .result-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--space-2);
        }
        .result-details {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 0;
            margin-top: var(--space-6);
            border: 1px solid var(--color-gray-200);
            overflow: hidden;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px var(--space-4);
            border-bottom: 1px solid var(--color-gray-100);
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            color: var(--color-gray-500);
            font-size: 13px;
        }
        .detail-value {
            font-weight: 600;
            color: var(--color-gray-900);
            font-size: 13px;
            font-variant-numeric: tabular-nums;
        }
        .hidden {
            display: none !important;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(16px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .card {
            animation: fadeIn 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* TOOLTIPS */
        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-gray-300);
            color: white;
            font-size: 11px;
            font-weight: 700;
            cursor: help;
            transition: all var(--transition-base);
            flex-shrink: 0;
        }
        .tooltip-trigger:hover {
            background: var(--color-primary);
            transform: scale(1.1);
        }
        .tooltip {
            position: absolute;
            z-index: 1000;
            background: var(--color-gray-900);
            border: none;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            padding: 8px 12px;
            max-width: 280px;
            font-size: 12px;
            font-weight: 500;
            line-height: 1.5;
            color: white;
            display: none;
            pointer-events: none;
        }
        .tooltip.show {
            display: block;
        }
        .tooltip-arrow {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--color-gray-900);
            border: none;
            transform: rotate(45deg);
        }
        .tooltip-arrow.top {
            bottom: -4px;
            left: 50%;
            margin-left: -4px;
        }
        .tooltip-arrow.bottom {
            top: -4px;
            left: 50%;
            margin-left: -4px;
        }
        
        /* ZONE CHART */
        .chart-section {
            margin-top: var(--space-6);
        }
        .chart-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--space-4);
            color: var(--color-gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-container {
            position: relative;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            overflow: hidden;
        }
        .chart-canvas {
            width: 100%;
            height: 400px;
            display: block;
        }
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-gray-100);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--color-gray-700);
        }
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .chart-note {
            margin-top: var(--space-3);
            padding: var(--space-3);
            background: #FEF3C7;
            border-left: 3px solid #D97706;
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: #92400E;
        }

        /* PROXIMITY SECTION */
        .proximity-section {
            margin-top: var(--space-6);
        }
        .proximity-bar-wrapper {
            background: var(--bg-surface);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
        }
        .proximity-current-value {
            text-align: center;
            margin-bottom: var(--space-3);
        }
        .proximity-current-value .label {
            font-size: 13px;
            color: var(--color-gray-500);
        }
        .proximity-current-value .value {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-gray-900);
            margin-left: 8px;
        }
        .proximity-bar-track {
            position: relative;
            height: 32px;
            background: var(--color-gray-100);
            border-radius: 16px;
            overflow: visible;
            margin: var(--space-4) 0;
            border: 1px solid var(--color-gray-200);
        }
        .proximity-bar-fill {
            height: 100%;
            border-radius: 16px;
            transition: width 0.5s ease;
        }
        .proximity-marker {
            position: absolute;
            top: -6px;
            width: 6px;
            height: 44px;
            background: #DC2626;
            border-radius: 3px;
            transform: translateX(-50%);
            box-shadow: 0 0 0 2px white, 0 0 0 4px #DC2626;
        }
        .proximity-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--color-gray-500);
            padding: 0 4px;
        }
        .proximity-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
            margin-top: var(--space-4);
        }
        .proximity-info-item {
            padding: var(--space-3);
            background: var(--color-gray-50);
            border-radius: var(--radius-md);
            font-size: 13px;
        }
        .proximity-info-item .label {
            color: var(--color-gray-500);
            margin-bottom: 4px;
            font-size: 12px;
        }
        .proximity-info-item .value {
            font-weight: 600;
            color: var(--color-gray-900);
        }
        .proximity-info-item .detail {
            font-size: 11px;
            color: var(--color-gray-400);
            margin-top: 2px;
        }

        /* DECISION TREE */
        .decision-tree-section {
            margin-top: var(--space-6);
        }
        .decision-tree {
            background: var(--bg-surface);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
        }
        .tree-node {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            position: relative;
            margin-left: var(--space-4);
        }
        .tree-node:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 13px;
            top: 40px;
            bottom: -12px;
            width: 2px;
            background: var(--color-gray-200);
        }
        .tree-node-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 13px;
            font-weight: 700;
        }
        .tree-node-icon.info {
            background: #DBEAFE;
            color: #2563EB;
        }
        .tree-node-icon.pass {
            background: #D1FAE5;
            color: #059669;
        }
        .tree-node-icon.fail {
            background: #FEE2E2;
            color: #DC2626;
        }
        .tree-node-icon.result {
            background: var(--color-primary-light);
            color: var(--color-primary);
        }
        .tree-node-icon.warning {
            background: #FEF3C7;
            color: #D97706;
        }
        .tree-node-content {
            flex: 1;
            min-width: 0;
        }
        .tree-node-label {
            font-size: 13px;
            color: var(--color-gray-500);
            margin-bottom: 2px;
        }
        .tree-node-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-gray-900);
        }
        .tree-node.decisive {
            background: var(--color-primary-light);
            border-radius: var(--radius-md);
        }
        .tree-node.decisive .tree-node-value {
            color: var(--color-primary-dark);
        }
        .tree-node.decisive::after {
            background: var(--color-primary) !important;
        }

        /* HISTORY SECTION */
        .history-section {
            margin-top: var(--space-6);
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }
        .history-header-actions {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
        }
        .history-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-base);
        }
        .history-item:hover {
            background: var(--bg-surface);
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
        }
        .history-item-check {
            width: 20px;
            height: 20px;
            accent-color: var(--color-primary);
            cursor: pointer;
            flex-shrink: 0;
        }
        .history-item-info {
            flex: 1;
            min-width: 0;
        }
        .history-item-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--color-gray-900);
            margin-bottom: 2px;
        }
        .history-item-meta {
            font-size: 12px;
            color: var(--color-gray-500);
        }
        .history-item-category {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .history-item-actions {
            display: flex;
            gap: var(--space-2);
            flex-shrink: 0;
        }
        .history-item-actions button {
            background: none;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-md);
            padding: 6px 8px;
            cursor: pointer;
            color: var(--color-gray-500);
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .history-item-actions button:hover {
            border-color: var(--color-gray-400);
            color: var(--color-gray-900);
            background: var(--color-gray-50);
        }
        .history-item-actions button.delete:hover {
            border-color: var(--color-error);
            color: var(--color-error);
            background: #FEE2E2;
        }
        .history-empty {
            text-align: center;
            padding: var(--space-8);
            color: var(--color-gray-400);
            font-size: 14px;
        }

        /* COMPARISON */
        .comparison-container {
            margin-top: var(--space-6);
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-4);
        }
        .comparison-card {
            background: var(--bg-surface);
            border: 2px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
        }
        .comparison-card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-gray-100);
            text-align: center;
        }
        .comparison-card-category {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: var(--space-3);
            text-align: center;
        }
        .comparison-card-detail {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
            border-bottom: 1px solid var(--color-gray-50);
        }
        .comparison-card-detail .label {
            color: var(--color-gray-500);
        }
        .comparison-card-detail .value {
            font-weight: 600;
            color: var(--color-gray-900);
        }

        /* NOTES & SHARING */
        .notes-section {
            margin-top: var(--space-6);
            padding-top: var(--space-6);
            border-top: 1px solid var(--color-gray-100);
        }
        .notes-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .notes-textarea {
            width: 100%;
            min-height: 80px;
            padding: var(--space-3);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 13px;
            color: var(--color-gray-900);
            resize: vertical;
            transition: border-color var(--transition-base);
            background: var(--bg-surface);
        }
        .notes-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--ring-primary);
        }
        .notes-textarea::placeholder {
            color: var(--color-gray-400);
        }
        .share-link-container {
            margin-top: var(--space-4);
        }
        .share-link-row {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-3);
        }
        .share-link-input {
            flex: 1;
            height: 40px;
            padding: 10px 12px;
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--color-gray-900);
            background: var(--color-gray-50);
            font-variant-numeric: tabular-nums;
        }
        .share-link-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--ring-primary);
        }
        .btn-sm {
            padding: 8px 14px;
            font-size: 13px;
            min-height: 36px;
        }
        .btn-success {
            background: var(--color-success);
            color: white;
        }
        .btn-success:hover {
            background: var(--color-primary-dark);
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--color-gray-900);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            font-size: 13px;
            font-weight: 500;
            z-index: 10000;
            animation: fadeIn 300ms ease;
            box-shadow: var(--shadow-lg);
        }
        .import-drop-zone {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            text-align: center;
            color: var(--color-gray-400);
            font-size: 13px;
            cursor: pointer;
            transition: all var(--transition-base);
            margin-top: var(--space-3);
        }
        .import-drop-zone:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
            background: var(--color-primary-light);
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--space-4);
            }
            .header h1 {
                font-size: 24px;
            }
            .card-header {
                padding: var(--space-4);
            }
            .card-body {
                padding: var(--space-4);
            }
            .option-grid {
                grid-template-columns: 1fr;
            }
            .btn-group {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
            .stepper {
                padding: var(--space-4);
            }
            .stepper-circle {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }
            .stepper-label {
                font-size: 11px;
            }
            .tooltip {
                max-width: 90vw;
            }
            .chart-canvas {
                height: 300px;
            }
            .proximity-info {
                grid-template-columns: 1fr;
            }
            .tree-node {
                margin-left: var(--space-2);
            }
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            .history-item {
                flex-wrap: wrap;
            }
            .history-item-actions {
                width: 100%;
                justify-content: flex-end;
            }
            .share-link-row {
                flex-direction: column;
            }
            .history-header {
                flex-direction: column;
                align-items: stretch;
            }
            .history-header-actions {
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <a href="index.html" class="back-link">
            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            <span>Retour à l'accueil</span>
        </a>

        <div class="header">
            <h1>Calculateur DESP</h1>
            <p>Déterminez la catégorie de votre équipement sous pression</p>
        </div>

        <div class="stepper">
            <div class="stepper-items">
                <div class="stepper-progress" id="stepperProgress"></div>
                <div class="stepper-item active" data-step="1">
                    <div class="stepper-circle">1</div>
                    <div class="stepper-label">Type</div>
                </div>
                <div class="stepper-item" data-step="2">
                    <div class="stepper-circle">2</div>
                    <div class="stepper-label">Fluide</div>
                </div>
                <div class="stepper-item" data-step="3">
                    <div class="stepper-circle">3</div>
                    <div class="stepper-label">Groupe</div>
                </div>
                <div class="stepper-item" data-step="4">
                    <div class="stepper-circle">4</div>
                    <div class="stepper-label">Paramètres</div>
                </div>
                <div class="stepper-item" data-step="5">
                    <div class="stepper-circle">5</div>
                    <div class="stepper-label">Cas particuliers</div>
                </div>
                <div class="stepper-item" data-step="6">
                    <div class="stepper-circle">6</div>
                    <div class="stepper-label">Résultat</div>
                </div>
            </div>
        </div>

        <div id="step1" class="card">
            <div class="card-header">
                <h2 class="card-title">Type d'équipement</h2>
                <p class="card-subtitle">Sélectionnez le type de votre équipement sous pression</p>
            </div>
            <div class="card-body">
                <div class="option-grid">
                    <div class="option-card" data-value="vessel" data-step="1">
                        <div class="option-title">
                            Récipient
                            <span class="tooltip-trigger" data-tooltip="recipientTooltip">i</span>
                        </div>
                        <div class="option-description">Enveloppe conçue pour contenir des fluides sous pression</div>
                    </div>
                    <div class="option-card" data-value="piping" data-step="1">
                        <div class="option-title">
                            Tuyauterie
                            <span class="tooltip-trigger" data-tooltip="tuyauterieTooltip">i</span>
                        </div>
                        <div class="option-description">Conduits destinés au transport de fluides</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="step2" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">Type de fluide</h2>
                <p class="card-subtitle">Quel est l'état du fluide contenu ou transporté ?</p>
            </div>
            <div class="card-body">
                <div class="option-grid">
                    <div class="option-card" data-value="gas" data-step="2">
                        <div class="option-title">
                            Gaz
                            <span class="tooltip-trigger" data-tooltip="gasTooltip">i</span>
                        </div>
                        <div class="option-description">Pression de vapeur > 0,5 bar au-dessus de la pression atmosphérique</div>
                    </div>
                    <div class="option-card" data-value="liquid" data-step="2">
                        <div class="option-title">
                            Liquide
                            <span class="tooltip-trigger" data-tooltip="liquidTooltip">i</span>
                        </div>
                        <div class="option-description">Tous les fluides qui ne répondent pas à la définition de "gaz"</div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(2)"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Retour</button>
                </div>
            </div>
        </div>

        <div id="step3" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">Groupe de fluide</h2>
                <p class="card-subtitle">À quel groupe appartient votre fluide ?</p>
            </div>
            <div class="card-body">
                <div class="option-grid">
                    <div class="option-card" data-value="group1" data-step="3">
                        <div class="option-title">
                            <span class="group-indicator danger"></span>
                            Groupe 1 (Dangereux)
                            <span class="tooltip-trigger" data-tooltip="group1Tooltip">i</span>
                        </div>
                        <div class="option-description">Explosible, inflammable, toxique, comburant</div>
                    </div>
                    <div class="option-card" data-value="group2" data-step="3">
                        <div class="option-title">
                            <span class="group-indicator safe"></span>
                            Groupe 2 (Non dangereux)
                            <span class="tooltip-trigger" data-tooltip="group2Tooltip">i</span>
                        </div>
                        <div class="option-description">Tous les autres fluides (air, azote, eau...)</div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(3)"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Retour</button>
                </div>
            </div>
        </div>

        <div id="step4" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">Paramètres techniques</h2>
                <p class="card-subtitle">Saisissez les caractéristiques de votre équipement</p>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <label class="input-label">
                        Pression Maximale Admissible (PS)
                        <span class="tooltip-trigger" data-tooltip="psTooltip">i</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="psInput" placeholder="Ex: 10" min="0" step="0.1">
                        <span class="input-unit">bar</span>
                    </div>
                    <div class="input-helper">La pression maximale pour laquelle l'équipement est conçu</div>
                    <div class="input-error" id="psError">Veuillez saisir une pression valide</div>
                </div>

                <div class="input-group" id="volumeGroup">
                    <label class="input-label">
                        Volume (V)
                        <span class="tooltip-trigger" data-tooltip="vTooltip">i</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="vInput" placeholder="Ex: 50" min="0" step="0.1">
                        <span class="input-unit">litres</span>
                    </div>
                    <div class="input-helper">Le volume intérieur du récipient</div>
                    <div class="input-error" id="vError">Veuillez saisir un volume valide</div>
                </div>

                <div class="input-group hidden" id="dnGroup">
                    <label class="input-label">
                        Dimension Nominale (DN)
                        <span class="tooltip-trigger" data-tooltip="dnTooltip">i</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="dnInput" placeholder="Ex: 100" min="0" step="1">
                        <span class="input-unit">DN</span>
                    </div>
                    <div class="input-helper">Désignation standardisée sans unité</div>
                    <div class="input-error" id="dnError">Veuillez saisir une DN valide</div>
                </div>

                <div class="info-box">
                    <div class="info-box-title">Calcul en temps réel</div>
                    <div class="info-box-text" id="calculationInfo">Saisissez les valeurs pour voir le calcul</div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(4)"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Retour</button>
                    <button class="btn btn-primary" onclick="nextStep(4)">Suivant <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                </div>
            </div>
        </div>

        <div id="step5" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">Cas particuliers</h2>
                <p class="card-subtitle">Conditions spéciales pouvant modifier la catégorie (optionnel)</p>
            </div>
            <div class="card-body">
                <div class="checkbox-group" id="specialCasesGroup"></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(5)"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Retour</button>
                    <button class="btn btn-primary" onclick="calculateResult()">Voir le résultat <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                </div>
            </div>
        </div>

        <div id="step6" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">Résultat de la classification</h2>
                <p class="card-subtitle">Classification selon la directive 2014/68/UE</p>
            </div>
            <div class="card-body">
                <div id="resultCard" class="result-card">
                    <div class="result-title" id="resultTitle">Catégorie</div>
                </div>

                <div class="result-details">
                    <div class="detail-row">
                        <span class="detail-label">Type d'équipement</span>
                        <span class="detail-value" id="detailType">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Type de fluide</span>
                        <span class="detail-value" id="detailFluid">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Groupe de fluide</span>
                        <span class="detail-value" id="detailGroup">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Pression (PS)</span>
                        <span class="detail-value" id="detailPS">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label" id="detailParamLabel">Volume (V)</span>
                        <span class="detail-value" id="detailParam">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Calcul</span>
                        <span class="detail-value" id="detailCalc">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Tableau appliqué</span>
                        <span class="detail-value" id="detailTable">-</span>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-box-title">Explication</div>
                    <div class="info-box-text" id="explanationText">-</div>
                </div>

                <!-- Zone Diagram -->
                <div class="chart-section" id="chartSection">
                    <div class="chart-section-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
                        Diagramme de zones réglementaires
                    </div>
                    <div class="chart-container">
                        <canvas id="zoneChart" class="chart-canvas"></canvas>
                        <div class="chart-legend" id="chartLegend"></div>
                        <div class="chart-note hidden" id="chartNote"></div>
                    </div>
                </div>

                <!-- Proximity Indicator -->
                <div class="proximity-section hidden" id="proximitySection">
                    <div class="chart-section-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="10"/></svg>
                        Indicateur de proximité
                    </div>
                    <div id="proximityContent"></div>
                </div>

                <!-- Decision Tree -->
                <div class="decision-tree-section hidden" id="decisionTreeSection">
                    <div class="chart-section-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><line x1="12" y1="8" x2="12" y2="14"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="18" r="3"/><path d="M12 14l-6 4M12 14l6 4"/></svg>
                        Arbre de décision
                    </div>
                    <div id="decisionTreeContent"></div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="resetTool()"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg> Nouvelle analyse</button>
                    <button class="btn btn-primary" onclick="exportToPDF()"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> Exporter en PDF</button>
                </div>

                <!-- Notes Section -->
                <div class="notes-section hidden" id="notesSection">
                    <div class="notes-section-title">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        Notes personnelles
                    </div>
                    <textarea class="notes-textarea" id="notesTextarea" placeholder="Ajoutez vos remarques, observations ou commentaires sur ce calcul..."></textarea>
                </div>

                <!-- Share Section -->
                <div class="share-link-container hidden" id="shareSection">
                    <div class="notes-section-title">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                        Partager ce calcul
                    </div>
                    <div class="share-link-row">
                        <input type="text" class="share-link-input" id="shareLinkInput" readonly placeholder="Cliquez sur Generer le lien...">
                        <button class="btn btn-sm btn-primary" onclick="shareByLink()">Lien</button>
                        <button class="btn btn-sm btn-secondary" onclick="copyShareLink()">Copier</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="card history-section hidden" id="historySection">
            <div class="card-header">
                <h2 class="card-title">Historique des calculs</h2>
                <p class="card-subtitle">Retrouvez et comparez vos calculs precedents</p>
            </div>
            <div class="card-body">
                <div class="history-header">
                    <div style="font-size:13px;color:var(--color-gray-500)" id="historyCount">0 calcul(s)</div>
                    <div class="history-header-actions">
                        <button class="btn btn-sm btn-secondary" onclick="showComparison()" id="compareBtn" style="display:none">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                            Comparer
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="exportToCSV()">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                            CSV
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="document.getElementById('importFileInput').click()">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                            Importer
                        </button>
                        <input type="file" id="importFileInput" accept=".csv,.json" style="display:none" onchange="importData(event)">
                        <button class="btn btn-sm btn-secondary delete" onclick="clearHistory()" style="color:var(--color-error);border-color:var(--color-error)">
                            Vider
                        </button>
                    </div>
                </div>
                <div class="history-list" id="historyList"></div>

                <!-- Comparison Container -->
                <div class="comparison-container hidden" id="comparisonContainer">
                    <div class="chart-section-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                        Comparaison
                    </div>
                    <div class="comparison-grid" id="comparisonGrid"></div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-secondary" onclick="hideComparison()">Fermer la comparaison</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOOLTIPS -->
    <div id="recipientTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Enveloppe fermée conçue pour contenir des fluides sous pression (ex: réservoirs, bouteilles, autoclaves)
    </div>
    <div id="tuyauterieTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Ensemble de composants destinés au transport de fluides (ex: tubes, raccords, vannes, flexibles)
    </div>
    <div id="gasTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Tout fluide ayant une pression de vapeur > 0,5 bar au-dessus de la pression atmosphérique à la température maximale admissible
    </div>
    <div id="liquidTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Tous les fluides ne répondant pas à la définition de "gaz"
    </div>
    <div id="group1Tooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Fluides dangereux : explosibles, extrêmement inflammables, inflammables, très toxiques, toxiques, comburants
    </div>
    <div id="group2Tooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Tous les autres fluides non couverts par le groupe 1 (ex: air, azote, eau, vapeur d'eau)
    </div>
    <div id="psTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Pression maximale pour laquelle l'équipement est conçu, fixée par le fabricant (en bar)
    </div>
    <div id="vTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Volume intérieur de l'enveloppe en litres, y compris le volume des tubulures jusqu'au premier raccordement
    </div>
    <div id="dnTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Désignation numérique de la dimension commune à tous les éléments d'une tuyauterie (sans unité, ex: DN 50, DN 100, DN 200)
    </div>

    <script>
        const state = {
            currentStep: 1,
            equipmentType: null,
            fluidType: null,
            fluidGroup: null,
            ps: null,
            v: null,
            dn: null,
            specialCases: [],
            finalCategory: null
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Check for shared URL first
            if (!loadFromURL()) {
                loadState();
            }
            setupOptionCards();
            setupInputListeners();
            setupTooltips();
            setupNotesAutoSave();
            updateStepper();
            renderHistory();
        });

        // Tooltips
        function setupTooltips() {
            document.querySelectorAll('.tooltip-trigger').forEach(trigger => {
                trigger.addEventListener('mouseenter', showTooltip);
                trigger.addEventListener('mouseleave', hideTooltip);
                trigger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showTooltip.call(this, e);
                });
            });
            
            document.addEventListener('click', hideAllTooltips);
        }

        function showTooltip(e) {
            const tooltipId = this.dataset.tooltip;
            const tooltip = document.getElementById(tooltipId);
            if (!tooltip) return;
            
            hideAllTooltips();
            
            const triggerRect = this.getBoundingClientRect();
            tooltip.style.left = (triggerRect.left + triggerRect.width / 2) + 'px';
            tooltip.style.top = (triggerRect.top - 10) + 'px';
            tooltip.style.transform = 'translate(-50%, -100%)';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            setTimeout(() => {
                const hoveredElement = document.querySelector('.tooltip-trigger:hover');
                if (!hoveredElement) {
                    hideAllTooltips();
                }
            }, 100);
        }

        function hideAllTooltips() {
            document.querySelectorAll('.tooltip').forEach(t => t.classList.remove('show'));
        }

        // LocalStorage
        function saveState() {
            try {
                localStorage.setItem('desp_calculator_state', JSON.stringify(state));
            } catch (e) {
                console.warn('Could not save state', e);
            }
        }

        function hasMeaningfulProgress(savedState) {
            return savedState.equipmentType !== null || savedState.currentStep > 1;
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('desp_calculator_state');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (hasMeaningfulProgress(parsed) && confirm('Reprendre le calcul précédent ?')) {
                        Object.assign(state, parsed);
                        restoreUI();
                    } else {
                        localStorage.removeItem('desp_calculator_state');
                    }
                }
            } catch (e) {
                console.warn('Could not load state', e);
            }
        }

        function restoreUI() {
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }
            document.getElementById(`step${state.currentStep}`).classList.remove('hidden');
            
            if (state.equipmentType) {
                const card = document.querySelector(`[data-value="${state.equipmentType}"][data-step="1"]`);
                if (card) card.classList.add('selected');
            }
            if (state.fluidType) {
                const card = document.querySelector(`[data-value="${state.fluidType}"][data-step="2"]`);
                if (card) card.classList.add('selected');
            }
            if (state.fluidGroup) {
                const card = document.querySelector(`[data-value="${state.fluidGroup}"][data-step="3"]`);
                if (card) card.classList.add('selected');
            }
            
            if (state.ps !== null) document.getElementById('psInput').value = state.ps;
            if (state.v !== null) document.getElementById('vInput').value = state.v;
            if (state.dn !== null) document.getElementById('dnInput').value = state.dn;
            
            if (state.currentStep >= 4) {
                if (state.equipmentType === 'vessel') {
                    document.getElementById('volumeGroup').classList.remove('hidden');
                    document.getElementById('dnGroup').classList.add('hidden');
                } else {
                    document.getElementById('volumeGroup').classList.add('hidden');
                    document.getElementById('dnGroup').classList.remove('hidden');
                }
            }
            
            updateStepper();
            updateCalculation();
        }

        function setupOptionCards() {
            document.querySelectorAll('.option-card').forEach(card => {
                card.addEventListener('click', function() {
                    const parent = this.parentElement;
                    const step = parseInt(this.dataset.step);
                    const value = this.dataset.value;
                    
                    parent.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    if (step === 1) state.equipmentType = value;
                    if (step === 2) state.fluidType = value;
                    if (step === 3) state.fluidGroup = value;
                    
                    saveState();
                    updateStepper();
                    
                    setTimeout(() => {
                        if (step < 4) nextStepAuto(step);
                    }, 300);
                });
            });
        }

        function setupInputListeners() {
            [document.getElementById('psInput'), document.getElementById('vInput'), document.getElementById('dnInput')].forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        this.classList.remove('error');
                        const errorEl = document.getElementById(this.id + 'Error');
                        if (errorEl) errorEl.classList.remove('visible');
                        updateCalculation();
                        saveState();
                    });
                }
            });
        }

        function updateCalculation() {
            const ps = parseFloat(document.getElementById('psInput').value);
            const v = parseFloat(document.getElementById('vInput').value);
            const dn = parseFloat(document.getElementById('dnInput').value);
            const calcInfo = document.getElementById('calculationInfo');
            
            if (state.equipmentType === 'vessel' && !isNaN(ps) && !isNaN(v)) {
                calcInfo.textContent = `PS × V = ${ps.toFixed(2)} × ${v.toFixed(2)} = ${(ps * v).toFixed(2)} bar.L`;
            } else if (state.equipmentType === 'piping' && !isNaN(ps) && !isNaN(dn)) {
                calcInfo.textContent = `PS × DN = ${ps.toFixed(2)} bar × DN ${dn.toFixed(0)} = ${(ps * dn).toFixed(2)}`;
            } else {
                calcInfo.textContent = 'Saisissez les valeurs pour voir le calcul';
            }
        }

        function updateStepper() {
            const items = document.querySelectorAll('.stepper-item');
            const progress = document.getElementById('stepperProgress');
            
            items.forEach((item, index) => {
                const stepNum = index + 1;
                item.classList.remove('active', 'completed');
                
                if (stepNum < state.currentStep) {
                    item.classList.add('completed');
                } else if (stepNum === state.currentStep) {
                    item.classList.add('active');
                }
            });
            
            const progressWidth = ((state.currentStep - 1) / 5) * 100;
            progress.style.width = `calc(${progressWidth}% - 80px)`;
        }

        function nextStepAuto(currentStep) {
            if (currentStep === 3) {
                if (state.equipmentType === 'vessel') {
                    document.getElementById('volumeGroup').classList.remove('hidden');
                    document.getElementById('dnGroup').classList.add('hidden');
                } else {
                    document.getElementById('volumeGroup').classList.add('hidden');
                    document.getElementById('dnGroup').classList.remove('hidden');
                }
            }
            
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            document.getElementById(`step${currentStep + 1}`).classList.remove('hidden');
            
            state.currentStep = currentStep + 1;
            saveState();
            updateStepper();
            window.scrollTo(0, 0);
        }

        function validateStep4() {
            const psInput = document.getElementById('psInput');
            const psError = document.getElementById('psError');
            const ps = parseFloat(psInput.value);
            
            let isValid = true;
            
            if (isNaN(ps) || ps < 0) {
                psInput.classList.add('error');
                psError.textContent = 'Veuillez saisir une pression valide (≥ 0)';
                psError.classList.add('visible');
                isValid = false;
            } else if (ps > 10000) {
                if (!confirm('Pression > 10 000 bar : valeur inhabituelle. Confirmer ?')) {
                    return false;
                }
            }
            
            if (!isValid) return false;
            
            if (state.equipmentType === 'vessel') {
                const vInput = document.getElementById('vInput');
                const vError = document.getElementById('vError');
                const v = parseFloat(vInput.value);
                
                if (isNaN(v) || v <= 0) {
                    vInput.classList.add('error');
                    vError.textContent = 'Veuillez saisir un volume valide (> 0)';
                    vError.classList.add('visible');
                    isValid = false;
                } else if (v > 1000000) {
                    if (!confirm('Volume > 1 000 000 L : valeur inhabituelle. Confirmer ?')) {
                        return false;
                    }
                }
                
                if (isValid) state.v = v;
            } else {
                const dnInput = document.getElementById('dnInput');
                const dnError = document.getElementById('dnError');
                const dn = parseFloat(dnInput.value);
                
                if (isNaN(dn) || dn <= 0) {
                    dnInput.classList.add('error');
                    dnError.textContent = 'Veuillez saisir une DN valide (> 0)';
                    dnError.classList.add('visible');
                    isValid = false;
                } else if (dn > 5000) {
                    if (!confirm('DN > 5000 : valeur inhabituelle. Confirmer ?')) {
                        return false;
                    }
                }
                
                if (isValid) state.dn = dn;
            }
            
            if (isValid) state.ps = ps;
            return isValid;
        }

        function nextStep(currentStep) {
            if (currentStep === 4) {
                if (!validateStep4()) return;
                
                if (state.ps <= 0.5) {
                    state.finalCategory = 'Non soumis';
                    displayQuickResult('Non soumis', 'PS ≤ 0,5 bar : équipement non soumis à la directive DESP 2014/68/UE', 'N/A');
                    document.getElementById('step4').classList.add('hidden');
                    document.getElementById('step6').classList.remove('hidden');
                    state.currentStep = 6;
                    saveState();
                    updateStepper();
                    // Save to history and show notes/share
                    currentHistoryId = saveToHistory('Non soumis', 'PS ≤ 0,5 bar : équipement non soumis à la directive DESP 2014/68/UE', 'N/A');
                    document.getElementById('notesSection').classList.remove('hidden');
                    document.getElementById('shareSection').classList.remove('hidden');
                    document.getElementById('notesTextarea').value = '';
                    window.scrollTo(0, 0);
                    return;
                }
                
                prepareSpecialCases();
            }
            
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            document.getElementById(`step${currentStep + 1}`).classList.remove('hidden');
            
            state.currentStep = currentStep + 1;
            saveState();
            updateStepper();
            window.scrollTo(0, 0);
        }

        function prevStep(currentStep) {
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            document.getElementById(`step${currentStep - 1}`).classList.remove('hidden');
            
            state.currentStep = currentStep - 1;
            saveState();
            updateStepper();
            window.scrollTo(0, 0);
        }

        function prepareSpecialCases() {
            const container = document.getElementById('specialCasesGroup');
            container.innerHTML = '';
            
            if (state.equipmentType === 'vessel' && state.fluidType === 'gas') {
                addSpecialCase(container, 'unstable_gas', 'Mon équipement contient un gaz instable',
                    'Reclassification automatique en Catégorie III si initialement I ou II',
                    'Gaz pouvant se décomposer de manière explosive sans participation d\'oxygène');
            }

            if (state.equipmentType === 'vessel' && state.fluidType === 'liquid' && state.fluidGroup === 'group2') {
                addSpecialCase(container, 'extinguisher', 'Mon équipement est un extincteur portable',
                    'Classement minimum en Catégorie III',
                    'Équipement portable destiné à la lutte contre l\'incendie');
                addSpecialCase(container, 'breathing', 'Mon équipement est une bouteille pour équipement respiratoire',
                    'Classement minimum en Catégorie III',
                    'Bouteille pour équipement de protection respiratoire');
            }

            if (state.equipmentType === 'piping' && state.fluidType === 'gas' && state.fluidGroup === 'group2') {
                addSpecialCase(container, 'unstable_gas_piping', 'Ma tuyauterie est destinée à un gaz instable',
                    'Reclassification automatique en Catégorie III si initialement I ou II',
                    'Gaz pouvant se décomposer de manière explosive');
            }

            if (state.equipmentType === 'piping') {
                addSpecialCase(container, 'high_temp', 'Ma tuyauterie contient des fluides à température > 350°C',
                    'Reclassification de Catégorie II vers Catégorie III',
                    'Fluides dont la température dépasse 350°C');
            }
            
            if (container.innerHTML === '') {
                container.innerHTML = '<div class="info-box"><div class="info-box-text">Aucun cas particulier applicable pour cette configuration.</div></div>';
            }
        }

        function addSpecialCase(container, id, title, description, tooltipText) {
            const div = document.createElement('div');
            div.className = 'checkbox-item';
            
            const tooltipId = id + 'Tooltip';
            const tooltip = document.createElement('div');
            tooltip.id = tooltipId;
            tooltip.className = 'tooltip';
            tooltip.innerHTML = '<div class="tooltip-arrow top"></div>' + tooltipText;
            document.body.appendChild(tooltip);
            
            div.innerHTML = `
                <input type="checkbox" id="${id}" value="${id}" ${state.specialCases.includes(id) ? 'checked' : ''}>
                <div class="checkbox-label">
                    <div class="checkbox-title">
                        ${title}
                        <span class="tooltip-trigger" data-tooltip="${tooltipId}">i</span>
                    </div>
                    <div class="checkbox-description">${description}</div>
                </div>
            `;
            container.appendChild(div);
            
            const tooltipTrigger = div.querySelector('.tooltip-trigger');
            tooltipTrigger.addEventListener('mouseenter', showTooltip);
            tooltipTrigger.addEventListener('mouseleave', hideTooltip);
            tooltipTrigger.addEventListener('click', function(e) {
                e.stopPropagation();
                showTooltip.call(this, e);
            });
            
            div.querySelector('input').addEventListener('change', function() {
                if (this.checked) {
                    if (!state.specialCases.includes(this.value)) {
                        state.specialCases.push(this.value);
                    }
                } else {
                    state.specialCases = state.specialCases.filter(c => c !== this.value);
                }
                saveState();
            });
        }

        // [Calculation functions remain exactly the same - truncated for brevity]
        // Include all calculateTable1-9, applySpecialCases, calculateResult, displayResult, exportToPDF, resetTool functions here
        
        function calculateTable1(ps, v) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (v <= 1) return { category: 'Article 4§3', explanation: 'V ≤ 1 L' };
            const ps_v = ps * v;
            if (ps_v <= 50) return { category: 'Article 4§3', explanation: 'PS×V ≤ 50 bar.L' };
            if (ps > 1000) return { category: 'Catégorie III', explanation: 'PS > 1000 bar' };
            if (ps_v > 1000 || ps > 200) return { category: 'Catégorie II', explanation: 'PS×V > 1000 bar.L ou PS > 200 bar' };
            return { category: 'Catégorie I', explanation: 'PS×V ≤ 1000 bar.L et PS ≤ 200 bar' };
        }

        function calculateTable2(ps, v) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (v <= 1) return { category: 'Article 4§3', explanation: 'V ≤ 1 L' };
            const ps_v = ps * v;
            if (ps_v <= 25) return { category: 'Article 4§3', explanation: 'PS×V ≤ 25 bar.L' };
            if (ps > 3000 || ps_v > 3000) return { category: 'Catégorie IV', explanation: 'PS > 3000 bar ou PS×V > 3000 bar.L' };
            if (ps_v > 1000) return { category: 'Catégorie III', explanation: 'PS×V > 1000 bar.L' };
            if (ps_v > 200) return { category: 'Catégorie II', explanation: '200 < PS×V ≤ 1000 bar.L' };
            return { category: 'Catégorie I', explanation: '25 < PS×V ≤ 200 bar.L' };
        }

        function calculateTable3(ps, v) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (v <= 1) return { category: 'Article 4§3', explanation: 'V ≤ 1 L' };
            const ps_v = ps * v;
            if (ps_v <= 200) return { category: 'Article 4§3', explanation: 'PS×V ≤ 200 bar.L' };
            if (ps > 500) return { category: 'Catégorie III', explanation: 'PS > 500 bar' };
            if (ps_v > 10000) return { category: 'Catégorie II', explanation: 'PS×V > 10000 bar.L' };
            return { category: 'Catégorie I', explanation: 'PS×V ≤ 10000 bar.L et PS ≤ 500 bar' };
        }

        function calculateTable4(ps, v) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (ps <= 10) return { category: 'Article 4§3', explanation: 'PS ≤ 10 bar' };
            const ps_v = ps * v;
            if (ps > 500) return { category: 'Catégorie II', explanation: 'PS > 500 bar' };
            if (ps_v > 10000) return { category: 'Catégorie II', explanation: 'PS×V > 10000 bar.L' };
            return { category: 'Catégorie I', explanation: 'PS×V ≤ 10000 bar.L et PS ≤ 500 bar' };
        }

        function calculateTable6(ps, dn) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (dn <= 25) return { category: 'Article 4§3', explanation: 'DN ≤ 25' };
            const ps_dn = ps * dn;
            if (ps_dn > 2500) return { category: 'Catégorie III', explanation: 'PS×DN > 2500' };
            if (ps_dn > 1000) return { category: 'Catégorie II', explanation: '1000 < PS×DN ≤ 2500' };
            return { category: 'Catégorie I', explanation: 'PS×DN ≤ 1000' };
        }

        function calculateTable7(ps, dn) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (dn <= 32) return { category: 'Article 4§3', explanation: 'DN ≤ 32' };
            const ps_dn = ps * dn;
            if (ps_dn > 3500) return { category: 'Catégorie III', explanation: 'PS×DN > 3500' };
            if (ps_dn > 1000) return { category: 'Catégorie II', explanation: '1000 < PS×DN ≤ 3500' };
            return { category: 'Catégorie I', explanation: 'PS×DN ≤ 1000' };
        }

        function calculateTable8(ps, dn) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (dn <= 25) return { category: 'Article 4§3', explanation: 'DN ≤ 25' };
            if (ps <= 10) return { category: 'Article 4§3', explanation: 'PS ≤ 10 bar' };
            const ps_dn = ps * dn;
            if (ps > 500) return { category: 'Catégorie III', explanation: 'PS > 500 bar' };
            if (ps_dn > 2000) return { category: 'Catégorie II', explanation: 'PS×DN > 2000' };
            return { category: 'Catégorie I', explanation: 'PS×DN ≤ 2000 et PS ≤ 500 bar' };
        }

        function calculateTable9(ps, dn) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (ps <= 10) return { category: 'Article 4§3', explanation: 'PS ≤ 10 bar' };
            const ps_dn = ps * dn;
            if (ps > 500) return { category: 'Catégorie II', explanation: 'PS > 500 bar' };
            if (ps_dn > 5000) return { category: 'Catégorie II', explanation: 'PS×DN > 5000' };
            return { category: 'Catégorie I', explanation: 'PS×DN ≤ 5000 et PS ≤ 500 bar' };
        }

        function applySpecialCases(category) {
            if (state.specialCases.includes('unstable_gas') || state.specialCases.includes('unstable_gas_piping')) {
                if (category === 'Catégorie I' || category === 'Catégorie II') return 'Catégorie III';
            }
            if (state.specialCases.includes('extinguisher') || state.specialCases.includes('breathing')) {
                if (category === 'Catégorie I' || category === 'Catégorie II' || category === 'Article 4§3') return 'Catégorie III';
            }
            if (state.specialCases.includes('high_temp')) {
                if (category === 'Catégorie II') return 'Catégorie III';
            }
            return category;
        }

        function calculateResult() {
            let category = '';
            let explanation = '';
            let tableNum = '';
            
            if (state.equipmentType === 'vessel' && state.fluidType === 'gas' && state.fluidGroup === 'group2') {
                tableNum = 'Table 1';
                const result = calculateTable1(state.ps, state.v);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'vessel' && state.fluidType === 'gas' && state.fluidGroup === 'group1') {
                tableNum = 'Table 2';
                const result = calculateTable2(state.ps, state.v);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'vessel' && state.fluidType === 'liquid' && state.fluidGroup === 'group2') {
                tableNum = 'Table 3';
                const result = calculateTable3(state.ps, state.v);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'vessel' && state.fluidType === 'liquid' && state.fluidGroup === 'group1') {
                tableNum = 'Table 4';
                const result = calculateTable4(state.ps, state.v);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'piping' && state.fluidType === 'gas' && state.fluidGroup === 'group2') {
                tableNum = 'Table 6';
                const result = calculateTable6(state.ps, state.dn);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'piping' && state.fluidType === 'gas' && state.fluidGroup === 'group1') {
                tableNum = 'Table 7';
                const result = calculateTable7(state.ps, state.dn);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'piping' && state.fluidType === 'liquid' && state.fluidGroup === 'group2') {
                tableNum = 'Table 8';
                const result = calculateTable8(state.ps, state.dn);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'piping' && state.fluidType === 'liquid' && state.fluidGroup === 'group1') {
                tableNum = 'Table 9';
                const result = calculateTable9(state.ps, state.dn);
                category = result.category;
                explanation = result.explanation;
            }
            
            if (!category) {
                category = 'Erreur de calcul';
                explanation = 'Configuration non reconnue. Veuillez vérifier vos paramètres.';
                tableNum = 'N/A';
                console.error('Configuration non gérée:', state);
            }
            
            let originalCategory = category;
            let wasReclassified = false;

            if (category !== 'Erreur de calcul') {
                category = applySpecialCases(category);
                if (originalCategory !== category) {
                    explanation += ` (Reclassification appliquée suite aux cas particuliers)`;
                    wasReclassified = true;
                }
            }

            state.finalCategory = category;
            displayResult(category, explanation, tableNum);

            document.getElementById('step5').classList.add('hidden');
            document.getElementById('step6').classList.remove('hidden');
            state.currentStep = 6;
            saveState();
            updateStepper();
            window.scrollTo(0, 0);

            // Draw zone chart
            const param = state.equipmentType === 'vessel' ? state.v : state.dn;
            drawZoneChart(tableNum, state.ps, param, wasReclassified, originalCategory, category);

            // Proximity indicator
            const tableNumInt = getTableNumber(tableNum);
            if (tableNumInt) {
                const proximityData = computeProximity(tableNumInt, state.ps, param, category);
                renderProximity(proximityData);
            }

            // Decision tree
            if (tableNumInt) {
                const treeNodes = buildDecisionTree(tableNumInt, state.ps, param, wasReclassified, originalCategory, category);
                renderDecisionTree(treeNodes);
            }

            // Save to history and show notes/share
            if (!skipHistorySave) {
                currentHistoryId = saveToHistory(category, explanation, tableNum);
                document.getElementById('notesTextarea').value = '';
            }
            skipHistorySave = false;
            document.getElementById('notesSection').classList.remove('hidden');
            document.getElementById('shareSection').classList.remove('hidden');
        }

        function displayQuickResult(category, explanation, tableNum) {
            const resultCard = document.getElementById('resultCard');
            const resultTitle = document.getElementById('resultTitle');

            resultTitle.textContent = category;
            resultCard.className = 'result-card result-art43';

            document.getElementById('detailType').textContent = state.equipmentType === 'vessel' ? 'Récipient' : 'Tuyauterie';
            document.getElementById('detailFluid').textContent = state.fluidType === 'gas' ? 'Gaz' : 'Liquide';
            document.getElementById('detailGroup').textContent = state.fluidGroup === 'group1' ? 'Groupe 1 (dangereux)' : 'Groupe 2 (non dangereux)';
            document.getElementById('detailPS').textContent = `${state.ps} bar`;
            document.getElementById('detailParamLabel').textContent = '-';
            document.getElementById('detailParam').textContent = 'N/A';
            document.getElementById('detailCalc').textContent = 'N/A';
            document.getElementById('detailTable').textContent = tableNum;
            document.getElementById('explanationText').textContent = explanation;

            // Hide chart, proximity and decision tree for quick results (PS ≤ 0.5)
            document.getElementById('chartSection').classList.add('hidden');
            document.getElementById('proximitySection').classList.add('hidden');
            document.getElementById('decisionTreeSection').classList.add('hidden');
        }

        function displayResult(category, explanation, tableNum) {
            const resultCard = document.getElementById('resultCard');
            const resultTitle = document.getElementById('resultTitle');
            
            resultTitle.textContent = category;
            
            resultCard.className = 'result-card';
            if (category.includes('Non soumis') || category.includes('Article 4§3')) {
                resultCard.classList.add('result-art43');
            } else if (category.includes('Catégorie I')) {
                resultCard.classList.add('result-cat1');
            } else if (category.includes('Catégorie II')) {
                resultCard.classList.add('result-cat2');
            } else if (category.includes('Catégorie III')) {
                resultCard.classList.add('result-cat3');
            } else if (category.includes('Catégorie IV')) {
                resultCard.classList.add('result-cat4');
            } else if (category.includes('Erreur')) {
                resultCard.classList.add('result-error');
            }
            
            document.getElementById('detailType').textContent = state.equipmentType === 'vessel' ? 'Récipient' : 'Tuyauterie';
            document.getElementById('detailFluid').textContent = state.fluidType === 'gas' ? 'Gaz' : 'Liquide';
            document.getElementById('detailGroup').textContent = state.fluidGroup === 'group1' ? 'Groupe 1 (dangereux)' : 'Groupe 2 (non dangereux)';
            document.getElementById('detailPS').textContent = `${state.ps} bar`;
            
            if (state.equipmentType === 'vessel') {
                document.getElementById('detailParamLabel').textContent = 'Volume (V)';
                document.getElementById('detailParam').textContent = `${state.v} litres`;
                document.getElementById('detailCalc').textContent = `PS × V = ${(state.ps * state.v).toFixed(2)} bar.L`;
            } else {
                document.getElementById('detailParamLabel').textContent = 'Dimension Nominale (DN)';
                document.getElementById('detailParam').textContent = `DN ${state.dn}`;
                document.getElementById('detailCalc').textContent = `PS × DN = ${(state.ps * state.dn).toFixed(2)}`;
            }
            
            document.getElementById('detailTable').textContent = tableNum;
            document.getElementById('explanationText').textContent = explanation;
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageW = doc.internal.pageSize.getWidth();
            const pageH = doc.internal.pageSize.getHeight();
            const margin = 15;
            const contentW = pageW - margin * 2;
            let y = 0;

            // ── Color palette for categories ──
            const catPdfColors = {
                'Non soumis':   { bg: [243,244,246], border: [156,163,175], text: [107,114,128] },
                'Article 4§3':  { bg: [229,231,235], border: [156,163,175], text: [107,114,128] },
                'Catégorie I':  { bg: [204,251,241], border: [13,148,136],  text: [15,118,110]  },
                'Catégorie II': { bg: [254,243,199], border: [217,119,6],   text: [146,64,14]   },
                'Catégorie III':{ bg: [255,237,213], border: [249,115,22],  text: [194,65,12]   },
                'Catégorie IV': { bg: [254,226,226], border: [220,38,38],   text: [153,27,27]   }
            };
            const catColor = catPdfColors[state.finalCategory] || catPdfColors['Catégorie I'];

            // ── Helper: draw rounded rect ──
            function roundedRect(x, y, w, h, r, fillColor, strokeColor) {
                if (fillColor) { doc.setFillColor(...fillColor); }
                if (strokeColor) { doc.setDrawColor(...strokeColor); doc.setLineWidth(0.5); }
                doc.roundedRect(x, y, w, h, r, r, fillColor && strokeColor ? 'FD' : (fillColor ? 'F' : 'S'));
            }

            // ── Helper: add footer to current page ──
            function addFooter() {
                const pageNum = doc.internal.getNumberOfPages();
                doc.setFontSize(7);
                doc.setTextColor(160, 160, 160);
                doc.text(`Classification DESP — Directive 2014/68/UE`, margin, pageH - 8);
                doc.text(`Page ${pageNum}`, pageW - margin, pageH - 8, { align: 'right' });
                doc.text(`Généré le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}`, pageW / 2, pageH - 8, { align: 'center' });
                // Thin line above footer
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                doc.line(margin, pageH - 13, pageW - margin, pageH - 13);
            }

            // ── Helper: check page break ──
            function checkPage(needed) {
                if (y + needed > pageH - 20) {
                    addFooter();
                    doc.addPage();
                    y = margin;
                }
            }

            // ===========================
            // PAGE 1 — Header banner
            // ===========================
            doc.setFillColor(17, 24, 39);
            doc.rect(0, 0, pageW, 38, 'F');

            doc.setFontSize(18);
            doc.setTextColor(255, 255, 255);
            doc.text('Classification DESP', margin, 16);

            doc.setFontSize(9);
            doc.setTextColor(180, 190, 210);
            doc.text('Directive 2014/68/UE — Équipements sous pression', margin, 24);
            doc.text(`Rapport du ${new Date().toLocaleDateString('fr-FR')}`, margin, 31);

            // ===========================
            // Classification result badge
            // ===========================
            y = 48;
            const badgeH = 28;
            roundedRect(margin, y, contentW, badgeH, 3, catColor.bg, catColor.border);

            doc.setFontSize(9);
            doc.setTextColor(...catColor.text);
            doc.text('RÉSULTAT DE CLASSIFICATION', margin + 6, y + 9);

            doc.setFontSize(16);
            doc.setTextColor(...catColor.text);
            doc.text(state.finalCategory || 'N/A', margin + 6, y + 22);

            // Table applied — right aligned
            const tableStr = document.getElementById('detailTable').textContent;
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text(tableStr, pageW - margin - 6, y + 16, { align: 'right' });

            y += badgeH + 10;

            // ===========================
            // Parameters table
            // ===========================
            doc.setFontSize(11);
            doc.setTextColor(17, 24, 39);
            doc.text('Paramètres de l\'équipement', margin, y);
            y += 6;

            // Table drawing
            const rows = [
                ['Type d\'équipement', state.equipmentType === 'vessel' ? 'Récipient' : 'Tuyauterie'],
                ['Type de fluide', state.fluidType === 'gas' ? 'Gaz' : 'Liquide'],
                ['Groupe de fluide', state.fluidGroup === 'group1' ? 'Groupe 1 (dangereux)' : 'Groupe 2 (non dangereux)'],
                ['Pression maximale (PS)', `${state.ps} bar`]
            ];

            if (state.equipmentType === 'vessel') {
                rows.push(['Volume (V)', `${state.v} litres`]);
                rows.push(['Produit PS × V', `${(state.ps * state.v).toFixed(2)} bar.L`]);
            } else {
                rows.push(['Dimension nominale (DN)', `DN ${state.dn}`]);
                rows.push(['Produit PS × DN', `${(state.ps * state.dn).toFixed(2)}`]);
            }

            const colLabelW = 65;
            const colValueW = contentW - colLabelW;
            const rowH = 8;

            for (let i = 0; i < rows.length; i++) {
                const ry = y + i * rowH;
                // Alternating row background
                if (i % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(margin, ry, contentW, rowH, 'F');
                }
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text(rows[i][0], margin + 4, ry + 5.5);
                doc.setTextColor(17, 24, 39);
                doc.text(rows[i][1], margin + colLabelW + 4, ry + 5.5);
            }

            // Table border
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.3);
            doc.rect(margin, y, contentW, rows.length * rowH);
            // Vertical separator
            doc.line(margin + colLabelW, y, margin + colLabelW, y + rows.length * rowH);

            y += rows.length * rowH + 10;

            // ===========================
            // Explanation section
            // ===========================
            const explanation = document.getElementById('explanationText').textContent;
            if (explanation) {
                checkPage(30);
                doc.setFontSize(11);
                doc.setTextColor(17, 24, 39);
                doc.text('Explication de la classification', margin, y);
                y += 5;

                // Light blue info box
                doc.setFontSize(8.5);
                doc.setTextColor(30, 58, 138);
                const splitExp = doc.splitTextToSize(explanation, contentW - 12);
                const expBoxH = splitExp.length * 4.5 + 8;
                roundedRect(margin, y, contentW, expBoxH, 2, [239, 246, 255], [147, 197, 253]);
                doc.text(splitExp, margin + 6, y + 6);
                y += expBoxH + 10;
            }

            // ===========================
            // Zone Diagram
            // ===========================
            const canvas = document.getElementById('zoneChart');
            const chartSection = document.getElementById('chartSection');
            if (canvas && chartSection && !chartSection.classList.contains('hidden')) {
                checkPage(14);
                doc.setFontSize(11);
                doc.setTextColor(17, 24, 39);
                doc.text('Diagramme des zones réglementaires', margin, y);
                y += 4;

                try {
                    const imgData = canvas.toDataURL('image/png', 1.0);
                    const imgW = contentW;
                    const imgH = (canvas.height / canvas.width) * imgW;
                    const finalImgH = Math.min(imgH, 90);

                    checkPage(finalImgH + 10);

                    // Light border around image
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.3);
                    doc.rect(margin, y, imgW, finalImgH);
                    doc.addImage(imgData, 'PNG', margin, y, imgW, finalImgH);
                    y += finalImgH + 5;

                    // Chart reclassification note
                    const chartNote = document.getElementById('chartNote');
                    if (chartNote && !chartNote.classList.contains('hidden')) {
                        doc.setFontSize(7.5);
                        doc.setTextColor(180, 83, 9);
                        const noteText = chartNote.textContent;
                        const splitNote = doc.splitTextToSize(noteText, contentW - 8);
                        roundedRect(margin, y, contentW, splitNote.length * 3.5 + 6, 2, [255, 251, 235], [253, 186, 116]);
                        doc.text(splitNote, margin + 4, y + 4.5);
                        y += splitNote.length * 3.5 + 10;
                    } else {
                        y += 5;
                    }
                } catch (e) {
                    console.warn('Could not embed chart in PDF:', e);
                    y += 5;
                }
            }

            // ===========================
            // Decision Tree
            // ===========================
            const tableNumInt = getTableNumber(tableStr);
            const param = state.equipmentType === 'vessel' ? state.v : state.dn;
            if (tableNumInt) {
                // Recalculate to get reclassification info
                let origCat = '';
                let wasCat = false;
                const calcFn = { 1: calculateTable1, 2: calculateTable2, 3: calculateTable3, 4: calculateTable4,
                                 6: calculateTable6, 7: calculateTable7, 8: calculateTable8, 9: calculateTable9 };
                if (calcFn[tableNumInt]) {
                    origCat = calcFn[tableNumInt](state.ps, param).category;
                    wasCat = origCat !== state.finalCategory;
                }

                const treeNodes = buildDecisionTree(tableNumInt, state.ps, param, wasCat, origCat, state.finalCategory);

                if (treeNodes && treeNodes.length > 0) {
                    checkPage(14);
                    doc.setFontSize(11);
                    doc.setTextColor(17, 24, 39);
                    doc.text('Arbre de décision', margin, y);
                    y += 6;

                    const nodeColors = {
                        info:     { bg: [239, 246, 255], border: [147, 197, 253], icon: [59, 130, 246],  text: [30, 58, 138] },
                        skip:     { bg: [249, 250, 251], border: [229, 231, 235], icon: [156, 163, 175], text: [107, 114, 128] },
                        decisive: { bg: [220, 252, 231], border: [74, 222, 128],  icon: [22, 163, 74],   text: [20, 83, 45] },
                        result:   { bg: catColor.bg,     border: catColor.border,  icon: catColor.text,   text: catColor.text },
                        warning:  { bg: [255, 251, 235], border: [253, 186, 116], icon: [217, 119, 6],   text: [146, 64, 14] }
                    };

                    const nodeIcons = { info: 'i', skip: '✗', decisive: '✓', result: '★', warning: '!' };
                    const treeNodeH = 9;
                    const iconColW = 8;

                    for (let i = 0; i < treeNodes.length; i++) {
                        const node = treeNodes[i];
                        const nc = nodeColors[node.type] || nodeColors.info;

                        checkPage(treeNodeH + 4);

                        // Connector line
                        if (i > 0) {
                            doc.setDrawColor(200, 200, 200);
                            doc.setLineWidth(0.4);
                            doc.line(margin + iconColW / 2, y - 2, margin + iconColW / 2, y);
                        }

                        // Node background
                        roundedRect(margin, y, contentW, treeNodeH, 1.5, nc.bg, nc.border);

                        // Icon circle
                        doc.setFillColor(...nc.icon);
                        doc.circle(margin + iconColW / 2, y + treeNodeH / 2, 2.5, 'F');
                        doc.setFontSize(6);
                        doc.setTextColor(255, 255, 255);
                        doc.text(nodeIcons[node.type] || '•', margin + iconColW / 2, y + treeNodeH / 2 + 1, { align: 'center' });

                        // Label
                        doc.setFontSize(8);
                        doc.setTextColor(...nc.text);
                        const isDecisive = node.type === 'decisive' || node.type === 'result';
                        if (isDecisive) {
                            doc.setFont(undefined, 'bold');
                        }
                        doc.text(node.label, margin + iconColW + 3, y + 4);

                        // Value — right portion
                        doc.setFontSize(7.5);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(...nc.text);
                        const maxValueW = contentW - iconColW - 6 - doc.getTextWidth(node.label) - 8;
                        if (maxValueW > 20) {
                            doc.text(node.value, pageW - margin - 4, y + 4, { align: 'right' });
                        } else {
                            // Value on second line
                            doc.text(node.value, margin + iconColW + 3, y + 7.5);
                        }

                        y += treeNodeH + 2;
                    }
                    y += 6;
                }

                // ===========================
                // Proximity Indicators
                // ===========================
                const proxData = computeProximity(tableNumInt, state.ps, param, state.finalCategory);
                if (proxData && (proxData.lowerThreshold || proxData.upperThreshold)) {
                    checkPage(14);
                    doc.setFontSize(11);
                    doc.setTextColor(17, 24, 39);
                    doc.text('Indicateurs de proximité', margin, y);
                    y += 6;

                    // Current value display
                    const productStr = `${proxData.productLabel} = ${proxData.product.toFixed(2)} ${proxData.productUnit}`;
                    doc.setFontSize(9);
                    doc.setTextColor(17, 24, 39);
                    doc.text(`Valeur actuelle : ${productStr}`, margin + 4, y + 4);
                    y += 8;

                    // Progress bar
                    const barX = margin + 4;
                    const barW = contentW - 8;
                    const barH = 8;

                    // Track
                    roundedRect(barX, y, barW, barH, 2, [243, 244, 246], [229, 231, 235]);

                    // Fill
                    const fillW = Math.max(2, barW * proxData.percentage / 100);
                    doc.setFillColor(...catColor.bg);
                    doc.roundedRect(barX, y, fillW, barH, 2, 2, 'F');
                    doc.setDrawColor(...catColor.border);
                    doc.setLineWidth(0.3);
                    doc.roundedRect(barX, y, fillW, barH, 2, 2, 'S');

                    // Marker
                    const markerX = barX + fillW;
                    doc.setFillColor(17, 24, 39);
                    doc.circle(markerX, y + barH / 2, 2, 'F');
                    doc.setFillColor(255, 255, 255);
                    doc.circle(markerX, y + barH / 2, 1, 'F');

                    y += barH + 3;

                    // Threshold labels under bar
                    doc.setFontSize(7);
                    doc.setTextColor(130, 130, 130);
                    if (proxData.lowerThreshold) {
                        doc.text(`${proxData.lowerThreshold.below} (${proxData.lowerThreshold.value})`, barX, y + 3);
                    } else {
                        doc.text('0', barX, y + 3);
                    }

                    doc.setTextColor(...catColor.text);
                    doc.setFontSize(7.5);
                    doc.text(proxData.category, barX + barW / 2, y + 3, { align: 'center' });

                    doc.setTextColor(130, 130, 130);
                    doc.setFontSize(7);
                    if (proxData.upperThreshold) {
                        doc.text(`${proxData.upperThreshold.above} (${proxData.upperThreshold.value})`, barX + barW, y + 3, { align: 'right' });
                    }
                    y += 8;

                    // Margin info cards
                    const cardW = (contentW - 10) / 2;
                    const cardH = 18;

                    if (proxData.lowerDistance !== null) {
                        roundedRect(margin, y, cardW, cardH, 2, [248, 249, 250], [229, 231, 235]);
                        doc.setFontSize(7);
                        doc.setTextColor(100, 100, 100);
                        doc.text('Marge inférieure', margin + 4, y + 5);
                        doc.setFontSize(10);
                        doc.setTextColor(17, 24, 39);
                        doc.text(`${proxData.lowerDistance.toFixed(2)} ${proxData.productUnit}`, margin + 4, y + 11);
                        doc.setFontSize(6.5);
                        doc.setTextColor(130, 130, 130);
                        doc.text(`Au-dessus du seuil ${proxData.lowerThreshold.value}`, margin + 4, y + 15.5);
                    }

                    if (proxData.upperDistance !== null) {
                        const cx = margin + cardW + 10;
                        roundedRect(cx, y, cardW, cardH, 2, [248, 249, 250], [229, 231, 235]);
                        doc.setFontSize(7);
                        doc.setTextColor(100, 100, 100);
                        doc.text('Marge supérieure', cx + 4, y + 5);
                        doc.setFontSize(10);
                        doc.setTextColor(17, 24, 39);
                        doc.text(`${proxData.upperDistance.toFixed(2)} ${proxData.productUnit}`, cx + 4, y + 11);
                        doc.setFontSize(6.5);
                        doc.setTextColor(130, 130, 130);
                        doc.text(`Avant le seuil ${proxData.upperThreshold.value}`, cx + 4, y + 15.5);
                    }

                    y += cardH + 8;
                }
            }

            // ===========================
            // Special cases note
            // ===========================
            if (state.specialCases && state.specialCases.length > 0) {
                checkPage(20);
                doc.setFontSize(11);
                doc.setTextColor(17, 24, 39);
                doc.text('Cas particuliers appliqués', margin, y);
                y += 5;

                const specialLabels = {
                    'unstable_gas': 'Gaz instable',
                    'unstable_gas_piping': 'Gaz instable (tuyauterie)',
                    'portable_extinguisher': 'Extincteur portable',
                    'breathing_equipment': 'Bouteille pour équipement respiratoire',
                    'high_temp_piping': 'Température > 350°C'
                };

                for (const sc of state.specialCases) {
                    const label = specialLabels[sc] || sc;
                    checkPage(8);
                    roundedRect(margin, y, contentW, 7, 1.5, [255, 251, 235], [253, 186, 116]);
                    doc.setFontSize(8);
                    doc.setTextColor(146, 64, 14);
                    doc.text(`⚠ ${label}`, margin + 4, y + 5);
                    y += 9;
                }
                y += 4;
            }

            // ===========================
            // Regulatory reference
            // ===========================
            checkPage(18);
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.2);
            doc.line(margin, y, pageW - margin, y);
            y += 5;
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('Référence réglementaire : Directive 2014/68/UE du Parlement européen et du Conseil relative à l\'harmonisation', margin, y);
            y += 3.5;
            doc.text('des législations des États membres concernant la mise à disposition sur le marché des équipements sous pression.', margin, y);
            y += 3.5;
            doc.text('Ce document est généré à titre indicatif et ne se substitue pas à une analyse réglementaire complète.', margin, y);

            // Add footer to last page
            addFooter();

            doc.save('classification_desp.pdf');
        }

        function resetTool() {
            if (state.currentStep > 1 && !confirm('Êtes-vous sûr de vouloir recommencer ?')) return;

            state.currentStep = 1;
            state.equipmentType = null;
            state.fluidType = null;
            state.fluidGroup = null;
            state.ps = null;
            state.v = null;
            state.dn = null;
            state.specialCases = [];
            state.finalCategory = null;

            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById('step1').classList.remove('hidden');
            document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('input').forEach(input => {
                input.value = '';
                input.classList.remove('error');
            });
            document.querySelectorAll('.input-error').forEach(error => error.classList.remove('visible'));

            localStorage.removeItem('desp_calculator_state');

            // Reset new feature states
            currentHistoryId = null;
            document.getElementById('notesSection').classList.add('hidden');
            document.getElementById('shareSection').classList.add('hidden');
            document.getElementById('notesTextarea').value = '';
            document.getElementById('shareLinkInput').value = '';

            updateStepper();
            renderHistory();
            window.scrollTo(0, 0);
        }

        // =====================================================
        // ZONE CHART - Diagramme de zones réglementaires
        // =====================================================

        const categoryColors = {
            'Non soumis': { fill: '#F3F4F6', stroke: '#9CA3AF', text: '#6B7280' },
            'Article 4§3': { fill: '#E5E7EB', stroke: '#9CA3AF', text: '#6B7280' },
            'Catégorie I': { fill: '#CCFBF1', stroke: '#0D9488', text: '#0F766E' },
            'Catégorie II': { fill: '#FEF3C7', stroke: '#D97706', text: '#92400E' },
            'Catégorie III': { fill: '#FFEDD5', stroke: '#F97316', text: '#C2410C' },
            'Catégorie IV': { fill: '#FEE2E2', stroke: '#DC2626', text: '#991B1B' }
        };

        const chartConfigs = {
            1: { xLabel: 'V (L)', yLabel: 'PS (bar)', xMin: 0.1, xMax: 10000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 1', subtitle: 'Récipients — Gaz — Groupe 2' },
            2: { xLabel: 'V (L)', yLabel: 'PS (bar)', xMin: 0.1, xMax: 10000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 2', subtitle: 'Récipients — Gaz — Groupe 1' },
            3: { xLabel: 'V (L)', yLabel: 'PS (bar)', xMin: 0.1, xMax: 10000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 3', subtitle: 'Récipients — Liquide — Groupe 2' },
            4: { xLabel: 'V (L)', yLabel: 'PS (bar)', xMin: 0.1, xMax: 10000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 4', subtitle: 'Récipients — Liquide — Groupe 1' },
            6: { xLabel: 'DN', yLabel: 'PS (bar)', xMin: 1, xMax: 2000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 6', subtitle: 'Tuyauteries — Gaz — Groupe 2' },
            7: { xLabel: 'DN', yLabel: 'PS (bar)', xMin: 1, xMax: 2000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 7', subtitle: 'Tuyauteries — Gaz — Groupe 1' },
            8: { xLabel: 'DN', yLabel: 'PS (bar)', xMin: 1, xMax: 2000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 8', subtitle: 'Tuyauteries — Liquide — Groupe 2' },
            9: { xLabel: 'DN', yLabel: 'PS (bar)', xMin: 1, xMax: 2000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 9', subtitle: 'Tuyauteries — Liquide — Groupe 1' }
        };

        function classifyPoint(tableNum, ps, param) {
            switch(tableNum) {
                case 1: return calculateTable1(ps, param).category;
                case 2: return calculateTable2(ps, param).category;
                case 3: return calculateTable3(ps, param).category;
                case 4: return calculateTable4(ps, param).category;
                case 6: return calculateTable6(ps, param).category;
                case 7: return calculateTable7(ps, param).category;
                case 8: return calculateTable8(ps, param).category;
                case 9: return calculateTable9(ps, param).category;
                default: return 'Non soumis';
            }
        }

        function getTableNumber(tableStr) {
            const match = tableStr.match(/\d+/);
            return match ? parseInt(match[0]) : null;
        }

        function drawZoneChart(tableStr, ps, param, wasReclassified = false, originalCategory = null, finalCategory = null) {
            const tableNum = getTableNumber(tableStr);
            if (!tableNum || !chartConfigs[tableNum]) {
                document.getElementById('chartSection').classList.add('hidden');
                return;
            }

            document.getElementById('chartSection').classList.remove('hidden');

            // Handle reclassification note
            const chartNote = document.getElementById('chartNote');
            if (wasReclassified && originalCategory && finalCategory) {
                chartNote.innerHTML = `<strong>Note :</strong> Le diagramme montre la classification standard (${originalCategory}). Votre équipement a été reclassifié en <strong>${finalCategory}</strong> suite aux cas particuliers sélectionnés.`;
                chartNote.classList.remove('hidden');
            } else {
                chartNote.classList.add('hidden');
            }

            const canvas = document.getElementById('zoneChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const config = chartConfigs[tableNum];

            // High-DPI support
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const W = rect.width;
            const H = rect.height;

            const margin = { top: 45, right: 30, bottom: 50, left: 65 };
            const plotW = W - margin.left - margin.right;
            const plotH = H - margin.top - margin.bottom;

            const logXMin = Math.log10(config.xMin);
            const logXMax = Math.log10(config.xMax);
            const logYMin = Math.log10(config.yMin);
            const logYMax = Math.log10(config.yMax);

            function xToPixel(val) {
                if (val <= 0) val = config.xMin;
                return margin.left + (Math.log10(val) - logXMin) / (logXMax - logXMin) * plotW;
            }
            function yToPixel(val) {
                if (val <= 0) val = config.yMin;
                return margin.top + plotH - (Math.log10(val) - logYMin) / (logYMax - logYMin) * plotH;
            }

            // Clear canvas
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, W, H);

            // Fill zones using pixel sampling
            const step = 3;
            for (let px = 0; px < plotW; px += step) {
                for (let py = 0; py < plotH; py += step) {
                    const logX = logXMin + (px / plotW) * (logXMax - logXMin);
                    const logY = logYMin + ((plotH - py) / plotH) * (logYMax - logYMin);
                    const x = Math.pow(10, logX);
                    const y = Math.pow(10, logY);

                    const category = classifyPoint(tableNum, y, x);
                    const color = categoryColors[category];
                    if (color) {
                        ctx.fillStyle = color.fill;
                        ctx.fillRect(margin.left + px, margin.top + py, step, step);
                    }
                }
            }

            // Draw grid lines (log scale)
            ctx.strokeStyle = 'rgba(0,0,0,0.08)';
            ctx.lineWidth = 1;

            for (let exp = Math.ceil(logXMin); exp <= Math.floor(logXMax); exp++) {
                const val = Math.pow(10, exp);
                if (val < config.xMin || val > config.xMax) continue;
                const px = xToPixel(val);
                ctx.beginPath();
                ctx.moveTo(px, margin.top);
                ctx.lineTo(px, margin.top + plotH);
                ctx.stroke();
            }

            for (let exp = Math.ceil(logYMin); exp <= Math.floor(logYMax); exp++) {
                const val = Math.pow(10, exp);
                if (val < config.yMin || val > config.yMax) continue;
                const py = yToPixel(val);
                ctx.beginPath();
                ctx.moveTo(margin.left, py);
                ctx.lineTo(margin.left + plotW, py);
                ctx.stroke();
            }

            // Draw axes
            ctx.strokeStyle = '#111827';
            ctx.lineWidth = 2;

            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, margin.top + plotH);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top + plotH);
            ctx.lineTo(margin.left + plotW, margin.top + plotH);
            ctx.stroke();

            // Axis labels
            ctx.fillStyle = '#111827';
            ctx.font = 'bold 12px -apple-system, sans-serif';

            ctx.save();
            ctx.translate(15, margin.top + plotH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText(config.yLabel, 0, 0);
            ctx.restore();

            ctx.textAlign = 'center';
            ctx.fillText(config.xLabel, margin.left + plotW / 2, H - 10);

            // Axis tick labels
            ctx.font = '10px -apple-system, sans-serif';
            ctx.fillStyle = '#6B7280';

            for (let exp = Math.ceil(logXMin); exp <= Math.floor(logXMax); exp++) {
                const val = Math.pow(10, exp);
                if (val < config.xMin || val > config.xMax) continue;
                const px = xToPixel(val);
                ctx.textAlign = 'center';
                ctx.fillText(val >= 1000 ? (val/1000) + 'k' : val.toString(), px, margin.top + plotH + 18);
            }

            for (let exp = Math.ceil(logYMin); exp <= Math.floor(logYMax); exp++) {
                const val = Math.pow(10, exp);
                if (val < config.yMin || val > config.yMax) continue;
                const py = yToPixel(val);
                ctx.textAlign = 'right';
                ctx.fillText(val >= 1000 ? (val/1000) + 'k' : val.toString(), margin.left - 8, py + 4);
            }

            // Draw marker (red crosshair) if valid
            if (ps > 0 && param > 0 && ps >= config.yMin && param >= config.xMin) {
                const mx = xToPixel(param);
                const my = yToPixel(ps);

                if (mx >= margin.left && mx <= margin.left + plotW &&
                    my >= margin.top && my <= margin.top + plotH) {

                    // Crosshair lines
                    ctx.strokeStyle = '#DC2626';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 3]);

                    ctx.beginPath();
                    ctx.moveTo(mx, margin.top);
                    ctx.lineTo(mx, margin.top + plotH);
                    ctx.stroke();

                    ctx.beginPath();
                    ctx.moveTo(margin.left, my);
                    ctx.lineTo(margin.left + plotW, my);
                    ctx.stroke();

                    ctx.setLineDash([]);

                    // Center dot
                    ctx.fillStyle = '#DC2626';
                    ctx.beginPath();
                    ctx.arc(mx, my, 8, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(mx, my, 4, 0, Math.PI * 2);
                    ctx.fill();

                    // Draw category label badge next to marker
                    if (finalCategory) {
                        const badgeColor = categoryColors[finalCategory] || categoryColors['Catégorie III'];
                        const labelText = finalCategory.replace('Catégorie ', 'CAT ');

                        ctx.font = 'bold 12px -apple-system, sans-serif';
                        const textWidth = ctx.measureText(labelText).width;
                        const badgeW = textWidth + 16;
                        const badgeH = 24;
                        const badgeX = mx + 15;
                        const badgeY = my - badgeH / 2;

                        // Badge background
                        ctx.fillStyle = badgeColor.fill;
                        ctx.strokeStyle = badgeColor.stroke;
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.roundRect(badgeX, badgeY, badgeW, badgeH, 4);
                        ctx.fill();
                        ctx.stroke();

                        // Badge text
                        ctx.fillStyle = badgeColor.text;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(labelText, badgeX + badgeW / 2, badgeY + badgeH / 2);
                    }
                }
            }

            // Title
            ctx.fillStyle = '#111827';
            ctx.font = 'bold 14px -apple-system, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(config.title + ' — ' + config.subtitle, margin.left, 22);

            // Build legend
            buildChartLegend(tableNum, finalCategory);
        }

        // =====================================================
        // PROXIMITY INDICATOR
        // =====================================================

        function computeProximity(tableNum, ps, param, category) {
            const product = ps * param;
            const isVessel = [1,2,3,4].includes(tableNum);
            const productLabel = isVessel ? 'PS\u00d7V' : 'PS\u00d7DN';
            const productUnit = isVessel ? 'bar.L' : '';

            // Product-based thresholds for each table
            // Each entry: { value, below: category below threshold, above: category above }
            const allThresholds = {
                1: [
                    { value: 50, below: 'Article 4\u00a73', above: 'Cat\u00e9gorie I' },
                    { value: 1000, below: 'Cat\u00e9gorie I', above: 'Cat\u00e9gorie II' }
                ],
                2: [
                    { value: 25, below: 'Article 4\u00a73', above: 'Cat\u00e9gorie I' },
                    { value: 200, below: 'Cat\u00e9gorie I', above: 'Cat\u00e9gorie II' },
                    { value: 1000, below: 'Cat\u00e9gorie II', above: 'Cat\u00e9gorie III' },
                    { value: 3000, below: 'Cat\u00e9gorie III', above: 'Cat\u00e9gorie IV' }
                ],
                3: [
                    { value: 200, below: 'Article 4\u00a73', above: 'Cat\u00e9gorie I' },
                    { value: 10000, below: 'Cat\u00e9gorie I', above: 'Cat\u00e9gorie II' }
                ],
                4: [
                    { value: 10000, below: 'Cat\u00e9gorie I', above: 'Cat\u00e9gorie II' }
                ],
                6: [
                    { value: 1000, below: 'Cat\u00e9gorie I', above: 'Cat\u00e9gorie II' },
                    { value: 2500, below: 'Cat\u00e9gorie II', above: 'Cat\u00e9gorie III' }
                ],
                7: [
                    { value: 1000, below: 'Cat\u00e9gorie I', above: 'Cat\u00e9gorie II' },
                    { value: 3500, below: 'Cat\u00e9gorie II', above: 'Cat\u00e9gorie III' }
                ],
                8: [
                    { value: 2000, below: 'Cat\u00e9gorie I', above: 'Cat\u00e9gorie II' }
                ],
                9: [
                    { value: 5000, below: 'Cat\u00e9gorie I', above: 'Cat\u00e9gorie II' }
                ]
            };

            const thresholds = allThresholds[tableNum] || [];

            let lowerT = null;
            let upperT = null;

            for (const t of thresholds) {
                if (product > t.value) {
                    lowerT = t;
                }
            }
            for (const t of thresholds) {
                if (product <= t.value) {
                    upperT = t;
                    break;
                }
            }

            // Calculate percentage position
            let percentage = 50;
            if (lowerT && upperT) {
                percentage = ((product - lowerT.value) / (upperT.value - lowerT.value)) * 100;
            } else if (upperT && !lowerT) {
                percentage = (product / upperT.value) * 100;
            } else if (lowerT && !upperT) {
                percentage = 100;
            }

            return {
                product: product,
                productLabel: productLabel,
                productUnit: productUnit,
                lowerThreshold: lowerT,
                upperThreshold: upperT,
                lowerDistance: lowerT ? product - lowerT.value : null,
                upperDistance: upperT ? upperT.value - product : null,
                percentage: Math.max(2, Math.min(98, percentage)),
                category: category
            };
        }

        function renderProximity(data) {
            const section = document.getElementById('proximitySection');
            const content = document.getElementById('proximityContent');

            if (!data.lowerThreshold && !data.upperThreshold) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            const catColor = categoryColors[data.category] || categoryColors['Cat\u00e9gorie I'];

            let html = '<div class="proximity-bar-wrapper">';

            // Current value
            html += '<div class="proximity-current-value">' +
                '<span class="label">Valeur actuelle :</span>' +
                '<span class="value">' + data.productLabel + ' = ' + data.product.toFixed(2) + ' ' + data.productUnit + '</span>' +
                '</div>';

            // Bar
            html += '<div class="proximity-bar-track">' +
                '<div class="proximity-bar-fill" style="width:' + data.percentage + '%;background:' + catColor.fill + ';border:1px solid ' + catColor.stroke + '"></div>' +
                '<div class="proximity-marker" style="left:' + data.percentage + '%"></div>' +
                '</div>';

            // Labels
            html += '<div class="proximity-labels">';
            if (data.lowerThreshold) {
                html += '<span>' + data.lowerThreshold.below + ' (' + data.lowerThreshold.value + ' ' + data.productUnit + ')</span>';
            } else {
                html += '<span>0</span>';
            }
            html += '<span style="font-weight:600;color:var(--color-gray-900);">' + data.category + '</span>';
            if (data.upperThreshold) {
                html += '<span>' + data.upperThreshold.above + ' (' + data.upperThreshold.value + ' ' + data.productUnit + ')</span>';
            } else {
                html += '<span></span>';
            }
            html += '</div>';

            // Distance info cards
            html += '<div class="proximity-info">';

            if (data.lowerDistance !== null) {
                const pctFromLower = data.lowerThreshold && data.upperThreshold
                    ? ((data.lowerDistance / (data.upperThreshold.value - data.lowerThreshold.value)) * 100).toFixed(1)
                    : null;
                html += '<div class="proximity-info-item">' +
                    '<div class="label">Marge inf\u00e9rieure</div>' +
                    '<div class="value">' + data.lowerDistance.toFixed(2) + ' ' + data.productUnit + '</div>' +
                    '<div class="detail">Au-dessus du seuil ' + data.lowerThreshold.value + (pctFromLower ? ' (' + pctFromLower + '%)' : '') + '</div>' +
                    '</div>';
            }

            if (data.upperDistance !== null) {
                const pctToUpper = data.lowerThreshold && data.upperThreshold
                    ? ((data.upperDistance / (data.upperThreshold.value - data.lowerThreshold.value)) * 100).toFixed(1)
                    : null;
                html += '<div class="proximity-info-item">' +
                    '<div class="label">Marge sup\u00e9rieure</div>' +
                    '<div class="value">' + data.upperDistance.toFixed(2) + ' ' + data.productUnit + '</div>' +
                    '<div class="detail">Avant le seuil ' + data.upperThreshold.value + (pctToUpper ? ' (' + pctToUpper + '%)' : '') + '</div>' +
                    '</div>';
            }

            html += '</div></div>';
            content.innerHTML = html;
        }

        // =====================================================
        // DECISION TREE
        // =====================================================

        function buildDecisionTree(tableNum, ps, param, wasReclassified, originalCategory, finalCategory) {
            const isVessel = [1,2,3,4].includes(tableNum);
            const product = ps * param;
            const productLabel = isVessel ? 'PS\u00d7V' : 'PS\u00d7DN';
            const paramLabel = isVessel ? 'V' : 'DN';
            const paramUnit = isVessel ? 'L' : '';

            const decisionChecks = {
                1: [
                    { test: function() { return ps <= 0.5; }, label: 'PS \u2264 0,5 bar ?', yesResult: 'Non soumis' },
                    { test: function() { return param <= 1; }, label: paramLabel + ' \u2264 1 ' + paramUnit + ' ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return product <= 50; }, label: productLabel + ' \u2264 50 bar.L ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return ps > 1000; }, label: 'PS > 1000 bar ?', yesResult: 'Cat\u00e9gorie III' },
                    { test: function() { return product > 1000 || ps > 200; }, label: productLabel + ' > 1000 ou PS > 200 ?', yesResult: 'Cat\u00e9gorie II' },
                    { test: function() { return true; }, label: 'Par d\u00e9faut', yesResult: 'Cat\u00e9gorie I' }
                ],
                2: [
                    { test: function() { return ps <= 0.5; }, label: 'PS \u2264 0,5 bar ?', yesResult: 'Non soumis' },
                    { test: function() { return param <= 1; }, label: paramLabel + ' \u2264 1 ' + paramUnit + ' ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return product <= 25; }, label: productLabel + ' \u2264 25 bar.L ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return ps > 3000 || product > 3000; }, label: 'PS > 3000 ou ' + productLabel + ' > 3000 ?', yesResult: 'Cat\u00e9gorie IV' },
                    { test: function() { return product > 1000; }, label: productLabel + ' > 1000 bar.L ?', yesResult: 'Cat\u00e9gorie III' },
                    { test: function() { return product > 200; }, label: productLabel + ' > 200 bar.L ?', yesResult: 'Cat\u00e9gorie II' },
                    { test: function() { return true; }, label: 'Par d\u00e9faut', yesResult: 'Cat\u00e9gorie I' }
                ],
                3: [
                    { test: function() { return ps <= 0.5; }, label: 'PS \u2264 0,5 bar ?', yesResult: 'Non soumis' },
                    { test: function() { return param <= 1; }, label: paramLabel + ' \u2264 1 ' + paramUnit + ' ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return product <= 200; }, label: productLabel + ' \u2264 200 bar.L ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return ps > 500; }, label: 'PS > 500 bar ?', yesResult: 'Cat\u00e9gorie III' },
                    { test: function() { return product > 10000; }, label: productLabel + ' > 10000 bar.L ?', yesResult: 'Cat\u00e9gorie II' },
                    { test: function() { return true; }, label: 'Par d\u00e9faut', yesResult: 'Cat\u00e9gorie I' }
                ],
                4: [
                    { test: function() { return ps <= 0.5; }, label: 'PS \u2264 0,5 bar ?', yesResult: 'Non soumis' },
                    { test: function() { return ps <= 10; }, label: 'PS \u2264 10 bar ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return ps > 500; }, label: 'PS > 500 bar ?', yesResult: 'Cat\u00e9gorie II' },
                    { test: function() { return product > 10000; }, label: productLabel + ' > 10000 bar.L ?', yesResult: 'Cat\u00e9gorie II' },
                    { test: function() { return true; }, label: 'Par d\u00e9faut', yesResult: 'Cat\u00e9gorie I' }
                ],
                6: [
                    { test: function() { return ps <= 0.5; }, label: 'PS \u2264 0,5 bar ?', yesResult: 'Non soumis' },
                    { test: function() { return param <= 25; }, label: 'DN \u2264 25 ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return product > 2500; }, label: productLabel + ' > 2500 ?', yesResult: 'Cat\u00e9gorie III' },
                    { test: function() { return product > 1000; }, label: productLabel + ' > 1000 ?', yesResult: 'Cat\u00e9gorie II' },
                    { test: function() { return true; }, label: 'Par d\u00e9faut', yesResult: 'Cat\u00e9gorie I' }
                ],
                7: [
                    { test: function() { return ps <= 0.5; }, label: 'PS \u2264 0,5 bar ?', yesResult: 'Non soumis' },
                    { test: function() { return param <= 32; }, label: 'DN \u2264 32 ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return product > 3500; }, label: productLabel + ' > 3500 ?', yesResult: 'Cat\u00e9gorie III' },
                    { test: function() { return product > 1000; }, label: productLabel + ' > 1000 ?', yesResult: 'Cat\u00e9gorie II' },
                    { test: function() { return true; }, label: 'Par d\u00e9faut', yesResult: 'Cat\u00e9gorie I' }
                ],
                8: [
                    { test: function() { return ps <= 0.5; }, label: 'PS \u2264 0,5 bar ?', yesResult: 'Non soumis' },
                    { test: function() { return param <= 25; }, label: 'DN \u2264 25 ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return ps <= 10; }, label: 'PS \u2264 10 bar ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return ps > 500; }, label: 'PS > 500 bar ?', yesResult: 'Cat\u00e9gorie III' },
                    { test: function() { return product > 2000; }, label: productLabel + ' > 2000 ?', yesResult: 'Cat\u00e9gorie II' },
                    { test: function() { return true; }, label: 'Par d\u00e9faut', yesResult: 'Cat\u00e9gorie I' }
                ],
                9: [
                    { test: function() { return ps <= 0.5; }, label: 'PS \u2264 0,5 bar ?', yesResult: 'Non soumis' },
                    { test: function() { return ps <= 10; }, label: 'PS \u2264 10 bar ?', yesResult: 'Article 4\u00a73' },
                    { test: function() { return ps > 500; }, label: 'PS > 500 bar ?', yesResult: 'Cat\u00e9gorie II' },
                    { test: function() { return product > 5000; }, label: productLabel + ' > 5000 ?', yesResult: 'Cat\u00e9gorie II' },
                    { test: function() { return true; }, label: 'Par d\u00e9faut', yesResult: 'Cat\u00e9gorie I' }
                ]
            };

            const checks = decisionChecks[tableNum] || [];
            var nodes = [];

            // Context nodes
            nodes.push({
                type: 'info',
                label: 'Donn\u00e9es d\u2019entr\u00e9e',
                value: 'PS = ' + ps + ' bar, ' + paramLabel + ' = ' + param + ' ' + paramUnit + ', ' + productLabel + ' = ' + product.toFixed(2)
            });

            nodes.push({
                type: 'info',
                label: 'Tableau appliqu\u00e9',
                value: 'Tableau ' + tableNum + ' \u2014 ' + (chartConfigs[tableNum] ? chartConfigs[tableNum].subtitle : '')
            });

            // Process decision checks
            var decided = false;
            for (var i = 0; i < checks.length; i++) {
                if (decided) break;
                var check = checks[i];
                var result = check.test();

                if (result) {
                    nodes.push({
                        type: 'decisive',
                        label: check.label,
                        value: 'Oui \u2192 ' + check.yesResult
                    });
                    decided = true;
                } else {
                    nodes.push({
                        type: 'skip',
                        label: check.label,
                        value: 'Non \u2192 v\u00e9rification suivante'
                    });
                }
            }

            // Reclassification
            if (wasReclassified && originalCategory !== finalCategory) {
                nodes.push({
                    type: 'warning',
                    label: 'Reclassification (cas particuliers)',
                    value: originalCategory + ' \u2192 ' + finalCategory
                });
            }

            // Final result
            nodes.push({
                type: 'result',
                label: 'Classification finale',
                value: finalCategory || originalCategory
            });

            return nodes;
        }

        function renderDecisionTree(nodes) {
            var section = document.getElementById('decisionTreeSection');
            var content = document.getElementById('decisionTreeContent');

            if (!nodes || nodes.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            var html = '<div class="decision-tree">';

            for (var i = 0; i < nodes.length; i++) {
                var node = nodes[i];
                var isDecisive = node.type === 'decisive';
                var iconClass, icon;

                switch (node.type) {
                    case 'info':
                        iconClass = 'info';
                        icon = '\u2139';
                        break;
                    case 'skip':
                        iconClass = 'fail';
                        icon = '\u2717';
                        break;
                    case 'decisive':
                        iconClass = 'pass';
                        icon = '\u2713';
                        break;
                    case 'result':
                        iconClass = 'result';
                        icon = '\u2605';
                        break;
                    case 'warning':
                        iconClass = 'warning';
                        icon = '\u26a0';
                        break;
                    default:
                        iconClass = 'info';
                        icon = '\u2022';
                }

                html += '<div class="tree-node' + (isDecisive ? ' decisive' : '') + '">' +
                    '<div class="tree-node-icon ' + iconClass + '">' + icon + '</div>' +
                    '<div class="tree-node-content">' +
                    '<div class="tree-node-label">' + node.label + '</div>' +
                    '<div class="tree-node-value">' + node.value + '</div>' +
                    '</div></div>';
            }

            html += '</div>';
            content.innerHTML = html;
        }

        function buildChartLegend(tableNum, finalCategory = null) {
            const legend = document.getElementById('chartLegend');
            if (!legend) return;

            const config = chartConfigs[tableNum];
            const existingCategories = new Set();

            // Sample to find which categories exist
            for (let logX = Math.log10(config.xMin); logX <= Math.log10(config.xMax); logX += 0.3) {
                for (let logY = Math.log10(config.yMin); logY <= Math.log10(config.yMax); logY += 0.3) {
                    existingCategories.add(classifyPoint(tableNum, Math.pow(10, logY), Math.pow(10, logX)));
                }
            }

            // Add final category if reclassified (e.g., Cat III from special cases)
            if (finalCategory && !existingCategories.has(finalCategory)) {
                existingCategories.add(finalCategory);
            }

            const categories = ['Non soumis', 'Article 4§3', 'Catégorie I', 'Catégorie II', 'Catégorie III', 'Catégorie IV'];

            legend.innerHTML = categories
                .filter(c => existingCategories.has(c))
                .map(c => `<div class="legend-item">
                    <div class="legend-color" style="background:${categoryColors[c].fill};border-color:${categoryColors[c].stroke}"></div>
                    <span>${c}</span>
                </div>`)
                .join('') +
                `<div class="legend-item">
                    <div class="legend-color" style="background:#DC2626;border-radius:50%"></div>
                    <span>Votre équipement</span>
                </div>`;
        }
        // =====================================================
        // NOTES AUTO-SAVE SETUP
        // =====================================================
        function setupNotesAutoSave() {
            var textarea = document.getElementById('notesTextarea');
            var debounceTimer = null;
            textarea.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(function() {
                    saveNotes();
                }, 500);
            });
        }

        // =====================================================
        // TOAST NOTIFICATION
        // =====================================================
        function showToast(message) {
            var existing = document.querySelector('.toast');
            if (existing) existing.remove();
            var toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(function() { toast.remove(); }, 3000);
        }

        // =====================================================
        // HISTORY MANAGEMENT
        // =====================================================
        function getHistory() {
            try {
                var data = localStorage.getItem('desp_calculator_history');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.warn('Could not load history', e);
                return [];
            }
        }

        function saveToHistory(category, explanation, tableNum) {
            var history = getHistory();
            var entry = {
                id: Date.now(),
                date: new Date().toISOString(),
                equipmentType: state.equipmentType,
                fluidType: state.fluidType,
                fluidGroup: state.fluidGroup,
                ps: state.ps,
                v: state.v,
                dn: state.dn,
                specialCases: state.specialCases.slice(),
                category: category,
                tableNum: tableNum,
                explanation: explanation,
                notes: ''
            };
            history.unshift(entry);
            // Keep max 50 entries
            if (history.length > 50) history = history.slice(0, 50);
            try {
                localStorage.setItem('desp_calculator_history', JSON.stringify(history));
            } catch (e) {
                console.warn('Could not save history', e);
            }
            renderHistory();
            return entry.id;
        }

        var currentHistoryId = null;
        var skipHistorySave = false;

        function renderHistory() {
            var history = getHistory();
            var section = document.getElementById('historySection');
            var list = document.getElementById('historyList');
            var countEl = document.getElementById('historyCount');

            if (history.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            countEl.textContent = history.length + ' calcul(s)';

            var html = '';
            for (var i = 0; i < history.length; i++) {
                var item = history[i];
                var date = new Date(item.date);
                var dateStr = date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'});
                var typeLabel = item.equipmentType === 'vessel' ? 'Recipient' : 'Tuyauterie';
                var fluidLabel = item.fluidType === 'gas' ? 'Gaz' : 'Liquide';
                var groupLabel = item.fluidGroup === 'group1' ? 'Gr.1' : 'Gr.2';
                var paramStr = item.equipmentType === 'vessel'
                    ? 'PS=' + item.ps + ' bar, V=' + item.v + ' L'
                    : 'PS=' + item.ps + ' bar, DN=' + item.dn;

                var catColor = categoryColors[item.category] || { fill: '#F3F4F6', stroke: '#9CA3AF', text: '#6B7280' };

                html += '<div class="history-item" data-id="' + item.id + '">' +
                    '<input type="checkbox" class="history-item-check" onclick="event.stopPropagation();updateCompareBtn()" data-id="' + item.id + '">' +
                    '<div class="history-item-info" onclick="loadHistoryItem(' + item.id + ')">' +
                    '<div class="history-item-title">' + typeLabel + ' / ' + fluidLabel + ' / ' + groupLabel + '</div>' +
                    '<div class="history-item-meta">' + paramStr + ' &mdash; ' + dateStr +
                    (item.notes ? ' &mdash; <em>' + item.notes.substring(0, 40) + (item.notes.length > 40 ? '...' : '') + '</em>' : '') +
                    '</div></div>' +
                    '<span class="history-item-category" style="background:' + catColor.fill + ';color:' + catColor.text + ';border:1px solid ' + catColor.stroke + '">' + item.category + '</span>' +
                    '<div class="history-item-actions">' +
                    '<button onclick="event.stopPropagation();loadHistoryItem(' + item.id + ')" title="Charger"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg></button>' +
                    '<button class="delete" onclick="event.stopPropagation();deleteHistoryItem(' + item.id + ')" title="Supprimer"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>' +
                    '</div></div>';
            }
            list.innerHTML = html;
            updateCompareBtn();
        }

        function loadHistoryItem(id) {
            var history = getHistory();
            var item = null;
            for (var i = 0; i < history.length; i++) {
                if (history[i].id === id) { item = history[i]; break; }
            }
            if (!item) return;

            state.equipmentType = item.equipmentType;
            state.fluidType = item.fluidType;
            state.fluidGroup = item.fluidGroup;
            state.ps = item.ps;
            state.v = item.v;
            state.dn = item.dn;
            state.specialCases = item.specialCases ? item.specialCases.slice() : [];
            state.currentStep = 6;
            state.finalCategory = item.category;

            currentHistoryId = id;

            // Restore UI inputs
            document.getElementById('psInput').value = item.ps || '';
            document.getElementById('vInput').value = item.v || '';
            document.getElementById('dnInput').value = item.dn || '';

            if (item.equipmentType === 'vessel') {
                document.getElementById('volumeGroup').classList.remove('hidden');
                document.getElementById('dnGroup').classList.add('hidden');
            } else {
                document.getElementById('volumeGroup').classList.add('hidden');
                document.getElementById('dnGroup').classList.remove('hidden');
            }

            // Show step 6
            for (var i = 1; i <= 6; i++) {
                document.getElementById('step' + i).classList.add('hidden');
            }
            document.getElementById('step6').classList.remove('hidden');
            updateStepper();

            // Recalculate the result (skip saving to history since it already exists)
            skipHistorySave = true;
            calculateResult();

            // Restore notes
            var notesTextarea = document.getElementById('notesTextarea');
            notesTextarea.value = item.notes || '';
            document.getElementById('notesSection').classList.remove('hidden');
            document.getElementById('shareSection').classList.remove('hidden');

            window.scrollTo(0, 0);
            showToast('Calcul charge depuis l\'historique');
        }

        function deleteHistoryItem(id) {
            if (!confirm('Supprimer ce calcul de l\'historique ?')) return;
            var history = getHistory();
            history = history.filter(function(h) { return h.id !== id; });
            try {
                localStorage.setItem('desp_calculator_history', JSON.stringify(history));
            } catch (e) {
                console.warn('Could not save history', e);
            }
            renderHistory();
            showToast('Calcul supprime');
        }

        function clearHistory() {
            if (!confirm('Vider tout l\'historique ? Cette action est irreversible.')) return;
            localStorage.removeItem('desp_calculator_history');
            renderHistory();
            showToast('Historique vide');
        }

        // =====================================================
        // COMPARISON
        // =====================================================
        function getSelectedHistoryIds() {
            var checks = document.querySelectorAll('.history-item-check:checked');
            var ids = [];
            checks.forEach(function(cb) { ids.push(parseInt(cb.dataset.id)); });
            return ids;
        }

        function updateCompareBtn() {
            var ids = getSelectedHistoryIds();
            var btn = document.getElementById('compareBtn');
            if (ids.length >= 2 && ids.length <= 4) {
                btn.style.display = '';
                btn.textContent = 'Comparer (' + ids.length + ')';
            } else {
                btn.style.display = 'none';
            }
        }

        function showComparison() {
            var ids = getSelectedHistoryIds();
            if (ids.length < 2 || ids.length > 4) {
                showToast('Selectionnez entre 2 et 4 calculs');
                return;
            }

            var history = getHistory();
            var items = [];
            for (var i = 0; i < ids.length; i++) {
                for (var j = 0; j < history.length; j++) {
                    if (history[j].id === ids[i]) {
                        items.push(history[j]);
                        break;
                    }
                }
            }

            var grid = document.getElementById('comparisonGrid');
            var html = '';

            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var catColor = categoryColors[item.category] || { fill: '#F3F4F6', text: '#6B7280', stroke: '#9CA3AF' };
                var typeLabel = item.equipmentType === 'vessel' ? 'Recipient' : 'Tuyauterie';
                var fluidLabel = item.fluidType === 'gas' ? 'Gaz' : 'Liquide';
                var groupLabel = item.fluidGroup === 'group1' ? 'Groupe 1' : 'Groupe 2';
                var paramLabel = item.equipmentType === 'vessel' ? 'Volume' : 'DN';
                var paramValue = item.equipmentType === 'vessel' ? (item.v + ' L') : ('DN ' + item.dn);
                var product = item.equipmentType === 'vessel' ? (item.ps * item.v) : (item.ps * item.dn);
                var productLabel = item.equipmentType === 'vessel' ? 'PS x V' : 'PS x DN';
                var date = new Date(item.date);
                var dateStr = date.toLocaleDateString('fr-FR');

                html += '<div class="comparison-card" style="border-color:' + catColor.stroke + '">' +
                    '<div class="comparison-card-title">' + typeLabel + ' / ' + fluidLabel + '</div>' +
                    '<div class="comparison-card-category" style="color:' + catColor.text + '">' + item.category + '</div>' +
                    '<div class="comparison-card-detail"><span class="label">Equipement</span><span class="value">' + typeLabel + '</span></div>' +
                    '<div class="comparison-card-detail"><span class="label">Fluide</span><span class="value">' + fluidLabel + '</span></div>' +
                    '<div class="comparison-card-detail"><span class="label">Groupe</span><span class="value">' + groupLabel + '</span></div>' +
                    '<div class="comparison-card-detail"><span class="label">PS</span><span class="value">' + item.ps + ' bar</span></div>' +
                    '<div class="comparison-card-detail"><span class="label">' + paramLabel + '</span><span class="value">' + paramValue + '</span></div>' +
                    '<div class="comparison-card-detail"><span class="label">' + productLabel + '</span><span class="value">' + product.toFixed(2) + '</span></div>' +
                    '<div class="comparison-card-detail"><span class="label">Tableau</span><span class="value">' + item.tableNum + '</span></div>' +
                    '<div class="comparison-card-detail"><span class="label">Date</span><span class="value">' + dateStr + '</span></div>' +
                    '</div>';
            }

            grid.innerHTML = html;
            document.getElementById('comparisonContainer').classList.remove('hidden');
            document.getElementById('comparisonContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function hideComparison() {
            document.getElementById('comparisonContainer').classList.add('hidden');
            // Uncheck all
            document.querySelectorAll('.history-item-check').forEach(function(cb) { cb.checked = false; });
            updateCompareBtn();
        }

        // =====================================================
        // EXPORT CSV
        // =====================================================
        function exportToCSV() {
            var history = getHistory();
            if (history.length === 0) {
                showToast('Aucun calcul a exporter');
                return;
            }

            var headers = ['Date','Type equipement','Type fluide','Groupe fluide','PS (bar)','Volume (L)','DN','Cas particuliers','Categorie','Tableau','Explication','Notes'];
            var rows = [headers.join(';')];

            for (var i = 0; i < history.length; i++) {
                var h = history[i];
                var date = new Date(h.date).toLocaleDateString('fr-FR') + ' ' + new Date(h.date).toLocaleTimeString('fr-FR');
                var typeLabel = h.equipmentType === 'vessel' ? 'Recipient' : 'Tuyauterie';
                var fluidLabel = h.fluidType === 'gas' ? 'Gaz' : 'Liquide';
                var groupLabel = h.fluidGroup === 'group1' ? 'Groupe 1' : 'Groupe 2';
                var specialCasesStr = (h.specialCases || []).join(', ');
                var row = [
                    '"' + date + '"',
                    typeLabel,
                    fluidLabel,
                    groupLabel,
                    h.ps,
                    h.v || '',
                    h.dn || '',
                    '"' + specialCasesStr + '"',
                    '"' + h.category + '"',
                    h.tableNum,
                    '"' + (h.explanation || '').replace(/"/g, '""') + '"',
                    '"' + (h.notes || '').replace(/"/g, '""') + '"'
                ];
                rows.push(row.join(';'));
            }

            var csvContent = '\uFEFF' + rows.join('\n');
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'historique_desp_' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Export CSV telecharge');
        }

        // =====================================================
        // IMPORT DATA (CSV / JSON)
        // =====================================================
        function importData(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                var imported = [];

                if (file.name.endsWith('.json')) {
                    try {
                        var data = JSON.parse(content);
                        if (Array.isArray(data)) {
                            imported = data;
                        } else if (data.history && Array.isArray(data.history)) {
                            imported = data.history;
                        }
                    } catch (err) {
                        showToast('Erreur: fichier JSON invalide');
                        return;
                    }
                } else if (file.name.endsWith('.csv')) {
                    imported = parseCSVImport(content);
                } else {
                    showToast('Format non supporte. Utilisez .csv ou .json');
                    return;
                }

                if (imported.length === 0) {
                    showToast('Aucune donnee valide trouvee');
                    return;
                }

                // Validate and normalize entries
                var valid = [];
                for (var i = 0; i < imported.length; i++) {
                    var item = imported[i];
                    if (item.equipmentType && item.fluidType && item.fluidGroup && item.ps != null && item.category) {
                        if (!item.id) item.id = Date.now() + i;
                        if (!item.date) item.date = new Date().toISOString();
                        if (!item.notes) item.notes = '';
                        if (!item.specialCases) item.specialCases = [];
                        valid.push(item);
                    }
                }

                if (valid.length === 0) {
                    showToast('Aucune entree valide dans le fichier');
                    return;
                }

                var history = getHistory();
                history = valid.concat(history);
                if (history.length > 50) history = history.slice(0, 50);

                try {
                    localStorage.setItem('desp_calculator_history', JSON.stringify(history));
                } catch (err) {
                    showToast('Erreur lors de la sauvegarde');
                    return;
                }

                renderHistory();
                showToast(valid.length + ' calcul(s) importe(s)');
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function parseCSVImport(content) {
            var lines = content.split('\n').filter(function(l) { return l.trim().length > 0; });
            if (lines.length < 2) return [];

            // Remove BOM if present
            if (lines[0].charCodeAt(0) === 0xFEFF) lines[0] = lines[0].substring(1);

            var results = [];
            for (var i = 1; i < lines.length; i++) {
                var cols = parseCSVLine(lines[i]);
                if (cols.length < 9) continue;

                var typeMap = { 'recipient': 'vessel', 'tuyauterie': 'piping' };
                var fluidMap = { 'gaz': 'gas', 'liquide': 'liquid' };
                var groupMap = { 'groupe 1': 'group1', 'groupe 2': 'group2' };

                var eqType = typeMap[cols[1].toLowerCase().trim()] || cols[1].trim();
                var flType = fluidMap[cols[2].toLowerCase().trim()] || cols[2].trim();
                var grType = groupMap[cols[3].toLowerCase().trim()] || cols[3].trim();

                results.push({
                    id: Date.now() + i,
                    date: cols[0] ? new Date().toISOString() : new Date().toISOString(),
                    equipmentType: eqType,
                    fluidType: flType,
                    fluidGroup: grType,
                    ps: parseFloat(cols[4]) || 0,
                    v: cols[5] ? parseFloat(cols[5]) : null,
                    dn: cols[6] ? parseFloat(cols[6]) : null,
                    specialCases: cols[7] ? cols[7].split(',').map(function(s) { return s.trim(); }).filter(Boolean) : [],
                    category: cols[8] || '',
                    tableNum: cols[9] || '',
                    explanation: cols[10] || '',
                    notes: cols[11] || ''
                });
            }
            return results;
        }

        function parseCSVLine(line) {
            var result = [];
            var current = '';
            var inQuotes = false;
            for (var i = 0; i < line.length; i++) {
                var c = line[i];
                if (c === '"') {
                    if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (c === ';' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += c;
                }
            }
            result.push(current);
            return result;
        }

        // =====================================================
        // NOTES
        // =====================================================
        function saveNotes() {
            if (currentHistoryId === null) return;
            var history = getHistory();
            var notes = document.getElementById('notesTextarea').value;
            for (var i = 0; i < history.length; i++) {
                if (history[i].id === currentHistoryId) {
                    history[i].notes = notes;
                    break;
                }
            }
            try {
                localStorage.setItem('desp_calculator_history', JSON.stringify(history));
            } catch (e) {
                console.warn('Could not save notes', e);
            }
            renderHistory();
        }

        // =====================================================
        // SHARE BY LINK
        // =====================================================
        function shareByLink() {
            if (!state.equipmentType || !state.fluidType || !state.fluidGroup || state.ps == null) {
                showToast('Aucun calcul a partager');
                return;
            }

            var params = new URLSearchParams();
            params.set('eq', state.equipmentType);
            params.set('fl', state.fluidType);
            params.set('gr', state.fluidGroup);
            params.set('ps', state.ps);
            if (state.equipmentType === 'vessel' && state.v != null) {
                params.set('v', state.v);
            }
            if (state.equipmentType === 'piping' && state.dn != null) {
                params.set('dn', state.dn);
            }
            if (state.specialCases && state.specialCases.length > 0) {
                params.set('sc', state.specialCases.join(','));
            }

            var url = window.location.origin + window.location.pathname + '?' + params.toString();
            document.getElementById('shareLinkInput').value = url;
            showToast('Lien genere');
        }

        function copyShareLink() {
            var input = document.getElementById('shareLinkInput');
            if (!input.value) {
                shareByLink();
            }
            if (input.value) {
                navigator.clipboard.writeText(input.value).then(function() {
                    showToast('Lien copie dans le presse-papiers');
                }).catch(function() {
                    input.select();
                    document.execCommand('copy');
                    showToast('Lien copie');
                });
            }
        }

        function loadFromURL() {
            var params = new URLSearchParams(window.location.search);
            if (!params.has('eq') || !params.has('fl') || !params.has('gr') || !params.has('ps')) {
                return false;
            }

            var eq = params.get('eq');
            var fl = params.get('fl');
            var gr = params.get('gr');
            var ps = parseFloat(params.get('ps'));

            if (!['vessel', 'piping'].includes(eq)) return false;
            if (!['gas', 'liquid'].includes(fl)) return false;
            if (!['group1', 'group2'].includes(gr)) return false;
            if (isNaN(ps) || ps < 0) return false;

            state.equipmentType = eq;
            state.fluidType = fl;
            state.fluidGroup = gr;
            state.ps = ps;

            if (eq === 'vessel') {
                var v = parseFloat(params.get('v'));
                if (!isNaN(v) && v > 0) state.v = v;
                else return false;
            } else {
                var dn = parseFloat(params.get('dn'));
                if (!isNaN(dn) && dn > 0) state.dn = dn;
                else return false;
            }

            if (params.has('sc')) {
                state.specialCases = params.get('sc').split(',').filter(Boolean);
            }

            // Set up UI
            document.getElementById('psInput').value = state.ps;
            document.getElementById('vInput').value = state.v || '';
            document.getElementById('dnInput').value = state.dn || '';

            if (state.equipmentType === 'vessel') {
                document.getElementById('volumeGroup').classList.remove('hidden');
                document.getElementById('dnGroup').classList.add('hidden');
            } else {
                document.getElementById('volumeGroup').classList.add('hidden');
                document.getElementById('dnGroup').classList.remove('hidden');
            }

            // Select option cards
            var eqCard = document.querySelector('[data-value="' + eq + '"][data-step="1"]');
            if (eqCard) eqCard.classList.add('selected');
            var flCard = document.querySelector('[data-value="' + fl + '"][data-step="2"]');
            if (flCard) flCard.classList.add('selected');
            var grCard = document.querySelector('[data-value="' + gr + '"][data-step="3"]');
            if (grCard) grCard.classList.add('selected');

            // Jump to result
            state.currentStep = 6;
            for (var i = 1; i <= 6; i++) {
                document.getElementById('step' + i).classList.add('hidden');
            }
            document.getElementById('step6').classList.remove('hidden');
            updateStepper();

            calculateResult();

            // Clean URL without reload
            window.history.replaceState({}, document.title, window.location.pathname);

            showToast('Calcul charge depuis le lien partage');
            return true;
        }

    </script>

</body>
</html>
