<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculateur de classification DESP 2014/68/UE pour équipements sous pression">
    <title>Calculateur DESP 2014/68/UE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --color-primary: #0D9488;
            --color-primary-dark: #0F766E;
            --color-primary-light: #F0FDFA;
            --color-accent: #111827;
            --color-accent-dark: #1F2937;
            --color-success: #0D9488;
            --color-warning: #D97706;
            --color-error: #DC2626;
            --color-info: #6B7280;
            --color-orange: #F97316;
            --color-gray-50: #F9FAFB;
            --color-gray-100: #F3F4F6;
            --color-gray-200: #E5E7EB;
            --color-gray-300: #D1D5DB;
            --color-gray-400: #9CA3AF;
            --color-gray-500: #6B7280;
            --color-gray-700: #374151;
            --color-gray-900: #111827;
            --bg-page: #F3F4F6;
            --bg-surface: #FFFFFF;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.05), 0 2px 4px rgba(0,0,0,0.03);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.05), 0 4px 6px rgba(0,0,0,0.03);
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
            --transition-fast: 150ms ease;
            --transition-base: 150ms ease;
            --ring-primary: 0 0 0 3px rgba(13, 148, 136, 0.15);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            font-weight: 400;
            line-height: 1.5;
            color: var(--color-gray-900);
            background: var(--bg-page);
            overflow-x: hidden;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 0;
            color: var(--color-gray-500);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color var(--transition-base);
        }
        .back-link:hover {
            color: var(--color-primary);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-10) var(--space-4);
        }
        .header {
            text-align: center;
            margin-bottom: var(--space-10);
        }
        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--space-2);
            color: var(--color-gray-900);
        }
        .header p {
            font-size: 16px;
            color: var(--color-gray-500);
        }
        .stepper {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }
        .stepper-items {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        .stepper-items::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: var(--color-gray-200);
            z-index: 0;
        }
        .stepper-progress {
            position: absolute;
            top: 20px;
            left: 40px;
            height: 2px;
            background: var(--color-primary);
            transition: width var(--transition-base);
            z-index: 1;
        }
        .stepper-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        .stepper-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-surface);
            border: 2px solid var(--color-gray-300);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-gray-500);
            transition: all var(--transition-base);
            margin-bottom: var(--space-2);
            font-size: 14px;
        }
        .stepper-item.active .stepper-circle {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
            box-shadow: var(--ring-primary);
        }
        .stepper-item.completed .stepper-circle {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }
        .stepper-label {
            font-size: 13px;
            color: var(--color-gray-500);
            text-align: center;
            font-weight: 500;
        }
        .stepper-item.active .stepper-label {
            color: var(--color-gray-900);
            font-weight: 600;
        }
        .card {
            background: var(--bg-surface);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            padding: 0;
            margin-bottom: var(--space-6);
            transition: box-shadow var(--transition-base);
        }
        .card-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--color-gray-100);
        }
        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: var(--space-2);
            color: var(--color-gray-900);
        }
        .card-subtitle {
            font-size: 14px;
            color: var(--color-gray-500);
        }
        .card-body {
            padding: var(--space-6);
        }
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-4);
        }
        .option-card {
            background: var(--bg-surface);
            border: 2px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
        }
        .option-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-lg);
        }
        .option-card.selected {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
            box-shadow: var(--ring-primary);
        }
        .icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }
        .icon-sm {
            width: 16px;
            height: 16px;
        }
        .group-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .group-indicator.danger {
            background-color: var(--color-error);
        }
        .group-indicator.safe {
            background-color: var(--color-success);
        }
        .option-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--space-2);
            color: var(--color-gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .option-description {
            font-size: 13px;
            color: var(--color-gray-500);
            line-height: 1.5;
        }
        .input-group {
            margin-bottom: var(--space-5);
        }
        .input-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-700);
            margin-bottom: 6px;
        }
        .input-wrapper {
            position: relative;
        }
        .input-field {
            width: 100%;
            height: 40px;
            padding: 10px 80px 10px 12px;
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all var(--transition-base);
            background: var(--bg-surface);
            color: var(--color-gray-900);
            font-variant-numeric: tabular-nums;
        }
        .input-field:hover {
            border-color: var(--color-gray-500);
        }
        .input-field:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--ring-primary);
        }
        .input-field.error {
            border-color: var(--color-error);
            background: #FEE2E2;
        }
        .input-unit {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-gray-500);
            font-weight: 600;
            pointer-events: none;
            font-size: 13px;
        }
        .input-helper {
            font-size: 12px;
            color: var(--color-gray-500);
            margin-top: 4px;
        }
        .input-error {
            font-size: 12px;
            color: var(--color-error);
            margin-top: 4px;
            display: none;
        }
        .input-error.visible {
            display: block;
        }
        .info-box {
            background: var(--color-gray-100);
            border-left: 4px solid var(--color-gray-300);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin: var(--space-5) 0;
        }
        .info-box-title {
            font-weight: 600;
            margin-bottom: var(--space-2);
            color: var(--color-gray-700);
            font-size: 14px;
        }
        .info-box-text {
            font-size: 13px;
            color: var(--color-gray-500);
            line-height: 1.5;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-height: 44px;
        }
        .btn-primary {
            background: var(--color-accent);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        .btn-primary:hover {
            background: var(--color-accent-dark);
        }
        .btn-primary:active {
            background: var(--color-gray-700);
            transform: scale(0.98);
        }
        .btn-secondary {
            background: var(--bg-surface);
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-300);
        }
        .btn-secondary:hover {
            background: var(--color-gray-50);
        }
        .btn-group {
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
            margin-top: var(--space-6);
        }
        .checkbox-group {
            margin: var(--space-5) 0;
        }
        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: var(--space-4);
            background: var(--color-gray-50);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
            cursor: pointer;
            transition: all var(--transition-base);
            border: 1px solid transparent;
        }
        .checkbox-item:hover {
            background: var(--bg-surface);
            border-color: var(--color-gray-200);
            box-shadow: var(--shadow-sm);
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: var(--space-4);
            margin-top: 2px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }
        .checkbox-label {
            flex: 1;
        }
        .checkbox-title {
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-2);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-description {
            font-size: 13px;
            color: var(--color-gray-500);
        }
        .result-card {
            padding: var(--space-8);
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: var(--space-6);
            border: 3px solid;
            background: var(--bg-surface);
        }
        .result-art43 { border-color: var(--color-info); }
        .result-art43 .result-title { color: var(--color-info); }
        .result-cat1 { border-color: var(--color-success); }
        .result-cat1 .result-title { color: var(--color-success); }
        .result-cat2 { border-color: var(--color-warning); }
        .result-cat2 .result-title { color: var(--color-warning); }
        .result-cat3 { border-color: var(--color-orange); }
        .result-cat3 .result-title { color: var(--color-orange); }
        .result-cat4 { border-color: var(--color-error); }
        .result-cat4 .result-title { color: var(--color-error); }
        .result-error { border-color: var(--color-error); }
        .result-error .result-title { color: var(--color-error); }
        .result-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--space-2);
        }
        .result-details {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 0;
            margin-top: var(--space-6);
            border: 1px solid var(--color-gray-200);
            overflow: hidden;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px var(--space-4);
            border-bottom: 1px solid var(--color-gray-100);
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            color: var(--color-gray-500);
            font-size: 13px;
        }
        .detail-value {
            font-weight: 600;
            color: var(--color-gray-900);
            font-size: 13px;
            font-variant-numeric: tabular-nums;
        }
        .hidden {
            display: none !important;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(16px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .card {
            animation: fadeIn 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* TOOLTIPS */
        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-gray-300);
            color: white;
            font-size: 11px;
            font-weight: 700;
            cursor: help;
            transition: all var(--transition-base);
            flex-shrink: 0;
        }
        .tooltip-trigger:hover {
            background: var(--color-primary);
            transform: scale(1.1);
        }
        .tooltip {
            position: absolute;
            z-index: 1000;
            background: var(--color-gray-900);
            border: none;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            padding: 8px 12px;
            max-width: 280px;
            font-size: 12px;
            font-weight: 500;
            line-height: 1.5;
            color: white;
            display: none;
            pointer-events: none;
        }
        .tooltip.show {
            display: block;
        }
        .tooltip-arrow {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--color-gray-900);
            border: none;
            transform: rotate(45deg);
        }
        .tooltip-arrow.top {
            bottom: -4px;
            left: 50%;
            margin-left: -4px;
        }
        .tooltip-arrow.bottom {
            top: -4px;
            left: 50%;
            margin-left: -4px;
        }
        
        /* ZONE CHART */
        .chart-section {
            margin-top: var(--space-6);
        }
        .chart-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--space-4);
            color: var(--color-gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-container {
            position: relative;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            overflow: hidden;
        }
        .chart-canvas {
            width: 100%;
            height: 400px;
            display: block;
        }
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-gray-100);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--color-gray-700);
        }
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--space-4);
            }
            .header h1 {
                font-size: 24px;
            }
            .card-header {
                padding: var(--space-4);
            }
            .card-body {
                padding: var(--space-4);
            }
            .option-grid {
                grid-template-columns: 1fr;
            }
            .btn-group {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
            .stepper {
                padding: var(--space-4);
            }
            .stepper-circle {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }
            .stepper-label {
                font-size: 11px;
            }
            .tooltip {
                max-width: 90vw;
            }
            .chart-canvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <a href="index.html" class="back-link">
            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            <span>Retour à l'accueil</span>
        </a>

        <div class="header">
            <h1>Calculateur DESP</h1>
            <p>Déterminez la catégorie de votre équipement sous pression</p>
        </div>

        <div class="stepper">
            <div class="stepper-items">
                <div class="stepper-progress" id="stepperProgress"></div>
                <div class="stepper-item active" data-step="1">
                    <div class="stepper-circle">1</div>
                    <div class="stepper-label">Type</div>
                </div>
                <div class="stepper-item" data-step="2">
                    <div class="stepper-circle">2</div>
                    <div class="stepper-label">Fluide</div>
                </div>
                <div class="stepper-item" data-step="3">
                    <div class="stepper-circle">3</div>
                    <div class="stepper-label">Groupe</div>
                </div>
                <div class="stepper-item" data-step="4">
                    <div class="stepper-circle">4</div>
                    <div class="stepper-label">Paramètres</div>
                </div>
                <div class="stepper-item" data-step="5">
                    <div class="stepper-circle">5</div>
                    <div class="stepper-label">Cas particuliers</div>
                </div>
                <div class="stepper-item" data-step="6">
                    <div class="stepper-circle">6</div>
                    <div class="stepper-label">Résultat</div>
                </div>
            </div>
        </div>

        <div id="step1" class="card">
            <div class="card-header">
                <h2 class="card-title">Type d'équipement</h2>
                <p class="card-subtitle">Sélectionnez le type de votre équipement sous pression</p>
            </div>
            <div class="card-body">
                <div class="option-grid">
                    <div class="option-card" data-value="vessel" data-step="1">
                        <div class="option-title">
                            Récipient
                            <span class="tooltip-trigger" data-tooltip="recipientTooltip">i</span>
                        </div>
                        <div class="option-description">Enveloppe conçue pour contenir des fluides sous pression</div>
                    </div>
                    <div class="option-card" data-value="piping" data-step="1">
                        <div class="option-title">
                            Tuyauterie
                            <span class="tooltip-trigger" data-tooltip="tuyauterieTooltip">i</span>
                        </div>
                        <div class="option-description">Conduits destinés au transport de fluides</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="step2" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">Type de fluide</h2>
                <p class="card-subtitle">Quel est l'état du fluide contenu ou transporté ?</p>
            </div>
            <div class="card-body">
                <div class="option-grid">
                    <div class="option-card" data-value="gas" data-step="2">
                        <div class="option-title">
                            Gaz
                            <span class="tooltip-trigger" data-tooltip="gasTooltip">i</span>
                        </div>
                        <div class="option-description">Pression de vapeur > 0,5 bar au-dessus de la pression atmosphérique</div>
                    </div>
                    <div class="option-card" data-value="liquid" data-step="2">
                        <div class="option-title">
                            Liquide
                            <span class="tooltip-trigger" data-tooltip="liquidTooltip">i</span>
                        </div>
                        <div class="option-description">Tous les fluides qui ne répondent pas à la définition de "gaz"</div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(2)"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Retour</button>
                </div>
            </div>
        </div>

        <div id="step3" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">Groupe de fluide</h2>
                <p class="card-subtitle">À quel groupe appartient votre fluide ?</p>
            </div>
            <div class="card-body">
                <div class="option-grid">
                    <div class="option-card" data-value="group1" data-step="3">
                        <div class="option-title">
                            <span class="group-indicator danger"></span>
                            Groupe 1 (Dangereux)
                            <span class="tooltip-trigger" data-tooltip="group1Tooltip">i</span>
                        </div>
                        <div class="option-description">Explosible, inflammable, toxique, comburant</div>
                    </div>
                    <div class="option-card" data-value="group2" data-step="3">
                        <div class="option-title">
                            <span class="group-indicator safe"></span>
                            Groupe 2 (Non dangereux)
                            <span class="tooltip-trigger" data-tooltip="group2Tooltip">i</span>
                        </div>
                        <div class="option-description">Tous les autres fluides (air, azote, eau...)</div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(3)"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Retour</button>
                </div>
            </div>
        </div>

        <div id="step4" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">Paramètres techniques</h2>
                <p class="card-subtitle">Saisissez les caractéristiques de votre équipement</p>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <label class="input-label">
                        Pression Maximale Admissible (PS)
                        <span class="tooltip-trigger" data-tooltip="psTooltip">i</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="psInput" placeholder="Ex: 10" min="0" step="0.1">
                        <span class="input-unit">bar</span>
                    </div>
                    <div class="input-helper">La pression maximale pour laquelle l'équipement est conçu</div>
                    <div class="input-error" id="psError">Veuillez saisir une pression valide</div>
                </div>

                <div class="input-group" id="volumeGroup">
                    <label class="input-label">
                        Volume (V)
                        <span class="tooltip-trigger" data-tooltip="vTooltip">i</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="vInput" placeholder="Ex: 50" min="0" step="0.1">
                        <span class="input-unit">litres</span>
                    </div>
                    <div class="input-helper">Le volume intérieur du récipient</div>
                    <div class="input-error" id="vError">Veuillez saisir un volume valide</div>
                </div>

                <div class="input-group hidden" id="dnGroup">
                    <label class="input-label">
                        Dimension Nominale (DN)
                        <span class="tooltip-trigger" data-tooltip="dnTooltip">i</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="dnInput" placeholder="Ex: 100" min="0" step="1">
                        <span class="input-unit">DN</span>
                    </div>
                    <div class="input-helper">Désignation standardisée sans unité</div>
                    <div class="input-error" id="dnError">Veuillez saisir une DN valide</div>
                </div>

                <div class="info-box">
                    <div class="info-box-title">Calcul en temps réel</div>
                    <div class="info-box-text" id="calculationInfo">Saisissez les valeurs pour voir le calcul</div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(4)"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Retour</button>
                    <button class="btn btn-primary" onclick="nextStep(4)">Suivant <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                </div>
            </div>
        </div>

        <div id="step5" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">Cas particuliers</h2>
                <p class="card-subtitle">Conditions spéciales pouvant modifier la catégorie (optionnel)</p>
            </div>
            <div class="card-body">
                <div class="checkbox-group" id="specialCasesGroup"></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(5)"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Retour</button>
                    <button class="btn btn-primary" onclick="calculateResult()">Voir le résultat <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                </div>
            </div>
        </div>

        <div id="step6" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">Résultat de la classification</h2>
                <p class="card-subtitle">Classification selon la directive 2014/68/UE</p>
            </div>
            <div class="card-body">
                <div id="resultCard" class="result-card">
                    <div class="result-title" id="resultTitle">Catégorie</div>
                </div>

                <div class="result-details">
                    <div class="detail-row">
                        <span class="detail-label">Type d'équipement</span>
                        <span class="detail-value" id="detailType">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Type de fluide</span>
                        <span class="detail-value" id="detailFluid">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Groupe de fluide</span>
                        <span class="detail-value" id="detailGroup">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Pression (PS)</span>
                        <span class="detail-value" id="detailPS">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label" id="detailParamLabel">Volume (V)</span>
                        <span class="detail-value" id="detailParam">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Calcul</span>
                        <span class="detail-value" id="detailCalc">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Tableau appliqué</span>
                        <span class="detail-value" id="detailTable">-</span>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-box-title">Explication</div>
                    <div class="info-box-text" id="explanationText">-</div>
                </div>

                <!-- Zone Diagram -->
                <div class="chart-section" id="chartSection">
                    <div class="chart-section-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
                        Diagramme de zones réglementaires
                    </div>
                    <div class="chart-container">
                        <canvas id="zoneChart" class="chart-canvas"></canvas>
                        <div class="chart-legend" id="chartLegend"></div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="resetTool()"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg> Nouvelle analyse</button>
                    <button class="btn btn-primary" onclick="exportToPDF()"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> Exporter en PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOOLTIPS -->
    <div id="recipientTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Enveloppe fermée conçue pour contenir des fluides sous pression (ex: réservoirs, bouteilles, autoclaves)
    </div>
    <div id="tuyauterieTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Ensemble de composants destinés au transport de fluides (ex: tubes, raccords, vannes, flexibles)
    </div>
    <div id="gasTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Tout fluide ayant une pression de vapeur > 0,5 bar au-dessus de la pression atmosphérique à la température maximale admissible
    </div>
    <div id="liquidTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Tous les fluides ne répondant pas à la définition de "gaz"
    </div>
    <div id="group1Tooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Fluides dangereux : explosibles, extrêmement inflammables, inflammables, très toxiques, toxiques, comburants
    </div>
    <div id="group2Tooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Tous les autres fluides non couverts par le groupe 1 (ex: air, azote, eau, vapeur d'eau)
    </div>
    <div id="psTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Pression maximale pour laquelle l'équipement est conçu, fixée par le fabricant (en bar)
    </div>
    <div id="vTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Volume intérieur de l'enveloppe en litres, y compris le volume des tubulures jusqu'au premier raccordement
    </div>
    <div id="dnTooltip" class="tooltip">
        <div class="tooltip-arrow top"></div>
        Désignation numérique de la dimension commune à tous les éléments d'une tuyauterie (sans unité, ex: DN 50, DN 100, DN 200)
    </div>

    <script>
        const state = {
            currentStep: 1,
            equipmentType: null,
            fluidType: null,
            fluidGroup: null,
            ps: null,
            v: null,
            dn: null,
            specialCases: [],
            finalCategory: null
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadState();
            setupOptionCards();
            setupInputListeners();
            setupTooltips();
            updateStepper();
        });

        // Tooltips
        function setupTooltips() {
            document.querySelectorAll('.tooltip-trigger').forEach(trigger => {
                trigger.addEventListener('mouseenter', showTooltip);
                trigger.addEventListener('mouseleave', hideTooltip);
                trigger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showTooltip.call(this, e);
                });
            });
            
            document.addEventListener('click', hideAllTooltips);
        }

        function showTooltip(e) {
            const tooltipId = this.dataset.tooltip;
            const tooltip = document.getElementById(tooltipId);
            if (!tooltip) return;
            
            hideAllTooltips();
            
            const triggerRect = this.getBoundingClientRect();
            tooltip.style.left = (triggerRect.left + triggerRect.width / 2) + 'px';
            tooltip.style.top = (triggerRect.top - 10) + 'px';
            tooltip.style.transform = 'translate(-50%, -100%)';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            setTimeout(() => {
                const hoveredElement = document.querySelector('.tooltip-trigger:hover');
                if (!hoveredElement) {
                    hideAllTooltips();
                }
            }, 100);
        }

        function hideAllTooltips() {
            document.querySelectorAll('.tooltip').forEach(t => t.classList.remove('show'));
        }

        // LocalStorage
        function saveState() {
            try {
                localStorage.setItem('desp_calculator_state', JSON.stringify(state));
            } catch (e) {
                console.warn('Could not save state', e);
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('desp_calculator_state');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (confirm('Reprendre le calcul précédent ?')) {
                        Object.assign(state, parsed);
                        restoreUI();
                    } else {
                        localStorage.removeItem('desp_calculator_state');
                    }
                }
            } catch (e) {
                console.warn('Could not load state', e);
            }
        }

        function restoreUI() {
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }
            document.getElementById(`step${state.currentStep}`).classList.remove('hidden');
            
            if (state.equipmentType) {
                const card = document.querySelector(`[data-value="${state.equipmentType}"][data-step="1"]`);
                if (card) card.classList.add('selected');
            }
            if (state.fluidType) {
                const card = document.querySelector(`[data-value="${state.fluidType}"][data-step="2"]`);
                if (card) card.classList.add('selected');
            }
            if (state.fluidGroup) {
                const card = document.querySelector(`[data-value="${state.fluidGroup}"][data-step="3"]`);
                if (card) card.classList.add('selected');
            }
            
            if (state.ps !== null) document.getElementById('psInput').value = state.ps;
            if (state.v !== null) document.getElementById('vInput').value = state.v;
            if (state.dn !== null) document.getElementById('dnInput').value = state.dn;
            
            if (state.currentStep >= 4) {
                if (state.equipmentType === 'vessel') {
                    document.getElementById('volumeGroup').classList.remove('hidden');
                    document.getElementById('dnGroup').classList.add('hidden');
                } else {
                    document.getElementById('volumeGroup').classList.add('hidden');
                    document.getElementById('dnGroup').classList.remove('hidden');
                }
            }
            
            updateStepper();
            updateCalculation();
        }

        function setupOptionCards() {
            document.querySelectorAll('.option-card').forEach(card => {
                card.addEventListener('click', function() {
                    const parent = this.parentElement;
                    const step = parseInt(this.dataset.step);
                    const value = this.dataset.value;
                    
                    parent.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    if (step === 1) state.equipmentType = value;
                    if (step === 2) state.fluidType = value;
                    if (step === 3) state.fluidGroup = value;
                    
                    saveState();
                    updateStepper();
                    
                    setTimeout(() => {
                        if (step < 4) nextStepAuto(step);
                    }, 300);
                });
            });
        }

        function setupInputListeners() {
            [document.getElementById('psInput'), document.getElementById('vInput'), document.getElementById('dnInput')].forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        this.classList.remove('error');
                        const errorEl = document.getElementById(this.id + 'Error');
                        if (errorEl) errorEl.classList.remove('visible');
                        updateCalculation();
                        saveState();
                    });
                }
            });
        }

        function updateCalculation() {
            const ps = parseFloat(document.getElementById('psInput').value);
            const v = parseFloat(document.getElementById('vInput').value);
            const dn = parseFloat(document.getElementById('dnInput').value);
            const calcInfo = document.getElementById('calculationInfo');
            
            if (state.equipmentType === 'vessel' && !isNaN(ps) && !isNaN(v)) {
                calcInfo.textContent = `PS × V = ${ps.toFixed(2)} × ${v.toFixed(2)} = ${(ps * v).toFixed(2)} bar.L`;
            } else if (state.equipmentType === 'piping' && !isNaN(ps) && !isNaN(dn)) {
                calcInfo.textContent = `PS × DN = ${ps.toFixed(2)} bar × DN ${dn.toFixed(0)} = ${(ps * dn).toFixed(2)}`;
            } else {
                calcInfo.textContent = 'Saisissez les valeurs pour voir le calcul';
            }
        }

        function updateStepper() {
            const items = document.querySelectorAll('.stepper-item');
            const progress = document.getElementById('stepperProgress');
            
            items.forEach((item, index) => {
                const stepNum = index + 1;
                item.classList.remove('active', 'completed');
                
                if (stepNum < state.currentStep) {
                    item.classList.add('completed');
                } else if (stepNum === state.currentStep) {
                    item.classList.add('active');
                }
            });
            
            const progressWidth = ((state.currentStep - 1) / 5) * 100;
            progress.style.width = `calc(${progressWidth}% - 80px)`;
        }

        function nextStepAuto(currentStep) {
            if (currentStep === 3) {
                if (state.equipmentType === 'vessel') {
                    document.getElementById('volumeGroup').classList.remove('hidden');
                    document.getElementById('dnGroup').classList.add('hidden');
                } else {
                    document.getElementById('volumeGroup').classList.add('hidden');
                    document.getElementById('dnGroup').classList.remove('hidden');
                }
            }
            
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            document.getElementById(`step${currentStep + 1}`).classList.remove('hidden');
            
            state.currentStep = currentStep + 1;
            saveState();
            updateStepper();
            window.scrollTo(0, 0);
        }

        function validateStep4() {
            const psInput = document.getElementById('psInput');
            const psError = document.getElementById('psError');
            const ps = parseFloat(psInput.value);
            
            let isValid = true;
            
            if (isNaN(ps) || ps < 0) {
                psInput.classList.add('error');
                psError.textContent = 'Veuillez saisir une pression valide (≥ 0)';
                psError.classList.add('visible');
                isValid = false;
            } else if (ps > 10000) {
                if (!confirm('Pression > 10 000 bar : valeur inhabituelle. Confirmer ?')) {
                    return false;
                }
            }
            
            if (!isValid) return false;
            
            if (state.equipmentType === 'vessel') {
                const vInput = document.getElementById('vInput');
                const vError = document.getElementById('vError');
                const v = parseFloat(vInput.value);
                
                if (isNaN(v) || v <= 0) {
                    vInput.classList.add('error');
                    vError.textContent = 'Veuillez saisir un volume valide (> 0)';
                    vError.classList.add('visible');
                    isValid = false;
                } else if (v > 1000000) {
                    if (!confirm('Volume > 1 000 000 L : valeur inhabituelle. Confirmer ?')) {
                        return false;
                    }
                }
                
                if (isValid) state.v = v;
            } else {
                const dnInput = document.getElementById('dnInput');
                const dnError = document.getElementById('dnError');
                const dn = parseFloat(dnInput.value);
                
                if (isNaN(dn) || dn <= 0) {
                    dnInput.classList.add('error');
                    dnError.textContent = 'Veuillez saisir une DN valide (> 0)';
                    dnError.classList.add('visible');
                    isValid = false;
                } else if (dn > 5000) {
                    if (!confirm('DN > 5000 : valeur inhabituelle. Confirmer ?')) {
                        return false;
                    }
                }
                
                if (isValid) state.dn = dn;
            }
            
            if (isValid) state.ps = ps;
            return isValid;
        }

        function nextStep(currentStep) {
            if (currentStep === 4) {
                if (!validateStep4()) return;
                
                if (state.ps <= 0.5) {
                    state.finalCategory = 'Non soumis';
                    displayQuickResult('Non soumis', 'PS ≤ 0,5 bar : équipement non soumis à la directive DESP 2014/68/UE', 'N/A');
                    document.getElementById('step4').classList.add('hidden');
                    document.getElementById('step6').classList.remove('hidden');
                    state.currentStep = 6;
                    saveState();
                    updateStepper();
                    window.scrollTo(0, 0);
                    return;
                }
                
                prepareSpecialCases();
            }
            
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            document.getElementById(`step${currentStep + 1}`).classList.remove('hidden');
            
            state.currentStep = currentStep + 1;
            saveState();
            updateStepper();
            window.scrollTo(0, 0);
        }

        function prevStep(currentStep) {
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            document.getElementById(`step${currentStep - 1}`).classList.remove('hidden');
            
            state.currentStep = currentStep - 1;
            saveState();
            updateStepper();
            window.scrollTo(0, 0);
        }

        function prepareSpecialCases() {
            const container = document.getElementById('specialCasesGroup');
            container.innerHTML = '';
            
            if (state.equipmentType === 'vessel' && state.fluidType === 'gas') {
                addSpecialCase(container, 'unstable_gas', 'Mon équipement contient un gaz instable',
                    'Reclassification automatique en Catégorie III si initialement I ou II',
                    'Gaz pouvant se décomposer de manière explosive sans participation d\'oxygène');
            }

            if (state.equipmentType === 'vessel' && state.fluidType === 'liquid' && state.fluidGroup === 'group2') {
                addSpecialCase(container, 'extinguisher', 'Mon équipement est un extincteur portable',
                    'Classement minimum en Catégorie III',
                    'Équipement portable destiné à la lutte contre l\'incendie');
                addSpecialCase(container, 'breathing', 'Mon équipement est une bouteille pour équipement respiratoire',
                    'Classement minimum en Catégorie III',
                    'Bouteille pour équipement de protection respiratoire');
            }

            if (state.equipmentType === 'piping' && state.fluidType === 'gas' && state.fluidGroup === 'group2') {
                addSpecialCase(container, 'unstable_gas_piping', 'Ma tuyauterie est destinée à un gaz instable',
                    'Reclassification automatique en Catégorie III si initialement I ou II',
                    'Gaz pouvant se décomposer de manière explosive');
            }

            if (state.equipmentType === 'piping') {
                addSpecialCase(container, 'high_temp', 'Ma tuyauterie contient des fluides à température > 350°C',
                    'Reclassification de Catégorie II vers Catégorie III',
                    'Fluides dont la température dépasse 350°C');
            }
            
            if (container.innerHTML === '') {
                container.innerHTML = '<div class="info-box"><div class="info-box-text">Aucun cas particulier applicable pour cette configuration.</div></div>';
            }
        }

        function addSpecialCase(container, id, title, description, tooltipText) {
            const div = document.createElement('div');
            div.className = 'checkbox-item';
            
            const tooltipId = id + 'Tooltip';
            const tooltip = document.createElement('div');
            tooltip.id = tooltipId;
            tooltip.className = 'tooltip';
            tooltip.innerHTML = '<div class="tooltip-arrow top"></div>' + tooltipText;
            document.body.appendChild(tooltip);
            
            div.innerHTML = `
                <input type="checkbox" id="${id}" value="${id}" ${state.specialCases.includes(id) ? 'checked' : ''}>
                <div class="checkbox-label">
                    <div class="checkbox-title">
                        ${title}
                        <span class="tooltip-trigger" data-tooltip="${tooltipId}">i</span>
                    </div>
                    <div class="checkbox-description">${description}</div>
                </div>
            `;
            container.appendChild(div);
            
            const tooltipTrigger = div.querySelector('.tooltip-trigger');
            tooltipTrigger.addEventListener('mouseenter', showTooltip);
            tooltipTrigger.addEventListener('mouseleave', hideTooltip);
            tooltipTrigger.addEventListener('click', function(e) {
                e.stopPropagation();
                showTooltip.call(this, e);
            });
            
            div.querySelector('input').addEventListener('change', function() {
                if (this.checked) {
                    if (!state.specialCases.includes(this.value)) {
                        state.specialCases.push(this.value);
                    }
                } else {
                    state.specialCases = state.specialCases.filter(c => c !== this.value);
                }
                saveState();
            });
        }

        // [Calculation functions remain exactly the same - truncated for brevity]
        // Include all calculateTable1-9, applySpecialCases, calculateResult, displayResult, exportToPDF, resetTool functions here
        
        function calculateTable1(ps, v) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (v <= 1) return { category: 'Article 4§3', explanation: 'V ≤ 1 L' };
            const ps_v = ps * v;
            if (ps_v <= 50) return { category: 'Article 4§3', explanation: 'PS×V ≤ 50 bar.L' };
            if (ps > 1000) return { category: 'Catégorie III', explanation: 'PS > 1000 bar' };
            if (ps_v > 1000 || ps > 200) return { category: 'Catégorie II', explanation: 'PS×V > 1000 bar.L ou PS > 200 bar' };
            return { category: 'Catégorie I', explanation: 'PS×V ≤ 1000 bar.L et PS ≤ 200 bar' };
        }

        function calculateTable2(ps, v) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (v <= 1) return { category: 'Article 4§3', explanation: 'V ≤ 1 L' };
            const ps_v = ps * v;
            if (ps_v <= 25) return { category: 'Article 4§3', explanation: 'PS×V ≤ 25 bar.L' };
            if (ps > 3000 || ps_v > 3000) return { category: 'Catégorie IV', explanation: 'PS > 3000 bar ou PS×V > 3000 bar.L' };
            if (ps_v > 1000) return { category: 'Catégorie III', explanation: 'PS×V > 1000 bar.L' };
            if (ps_v > 200) return { category: 'Catégorie II', explanation: '200 < PS×V ≤ 1000 bar.L' };
            return { category: 'Catégorie I', explanation: '25 < PS×V ≤ 200 bar.L' };
        }

        function calculateTable3(ps, v) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (v <= 1) return { category: 'Article 4§3', explanation: 'V ≤ 1 L' };
            const ps_v = ps * v;
            if (ps_v <= 200) return { category: 'Article 4§3', explanation: 'PS×V ≤ 200 bar.L' };
            if (ps > 500) return { category: 'Catégorie III', explanation: 'PS > 500 bar' };
            if (ps_v > 10000) return { category: 'Catégorie II', explanation: 'PS×V > 10000 bar.L' };
            return { category: 'Catégorie I', explanation: 'PS×V ≤ 10000 bar.L et PS ≤ 500 bar' };
        }

        function calculateTable4(ps, v) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (ps <= 10) return { category: 'Article 4§3', explanation: 'PS ≤ 10 bar' };
            const ps_v = ps * v;
            if (ps > 500) return { category: 'Catégorie II', explanation: 'PS > 500 bar' };
            if (ps_v > 10000) return { category: 'Catégorie II', explanation: 'PS×V > 10000 bar.L' };
            return { category: 'Catégorie I', explanation: 'PS×V ≤ 10000 bar.L et PS ≤ 500 bar' };
        }

        function calculateTable6(ps, dn) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (dn <= 25) return { category: 'Article 4§3', explanation: 'DN ≤ 25' };
            const ps_dn = ps * dn;
            if (ps_dn > 2500) return { category: 'Catégorie III', explanation: 'PS×DN > 2500' };
            if (ps_dn > 1000) return { category: 'Catégorie II', explanation: '1000 < PS×DN ≤ 2500' };
            return { category: 'Catégorie I', explanation: 'PS×DN ≤ 1000' };
        }

        function calculateTable7(ps, dn) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (dn <= 32) return { category: 'Article 4§3', explanation: 'DN ≤ 32' };
            const ps_dn = ps * dn;
            if (ps_dn > 3500) return { category: 'Catégorie III', explanation: 'PS×DN > 3500' };
            if (ps_dn > 1000) return { category: 'Catégorie II', explanation: '1000 < PS×DN ≤ 3500' };
            return { category: 'Catégorie I', explanation: 'PS×DN ≤ 1000' };
        }

        function calculateTable8(ps, dn) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (dn <= 25) return { category: 'Article 4§3', explanation: 'DN ≤ 25' };
            if (ps <= 10) return { category: 'Article 4§3', explanation: 'PS ≤ 10 bar' };
            const ps_dn = ps * dn;
            if (ps > 500) return { category: 'Catégorie III', explanation: 'PS > 500 bar' };
            if (ps_dn > 2000) return { category: 'Catégorie II', explanation: 'PS×DN > 2000' };
            return { category: 'Catégorie I', explanation: 'PS×DN ≤ 2000 et PS ≤ 500 bar' };
        }

        function calculateTable9(ps, dn) {
            if (ps <= 0.5) return { category: 'Non soumis', explanation: 'PS ≤ 0,5 bar' };
            if (ps <= 10) return { category: 'Article 4§3', explanation: 'PS ≤ 10 bar' };
            const ps_dn = ps * dn;
            if (ps > 500) return { category: 'Catégorie II', explanation: 'PS > 500 bar' };
            if (ps_dn > 5000) return { category: 'Catégorie II', explanation: 'PS×DN > 5000' };
            return { category: 'Catégorie I', explanation: 'PS×DN ≤ 5000 et PS ≤ 500 bar' };
        }

        function applySpecialCases(category) {
            if (state.specialCases.includes('unstable_gas') || state.specialCases.includes('unstable_gas_piping')) {
                if (category === 'Catégorie I' || category === 'Catégorie II') return 'Catégorie III';
            }
            if (state.specialCases.includes('extinguisher') || state.specialCases.includes('breathing')) {
                if (category === 'Catégorie I' || category === 'Catégorie II' || category === 'Article 4§3') return 'Catégorie III';
            }
            if (state.specialCases.includes('high_temp')) {
                if (category === 'Catégorie II') return 'Catégorie III';
            }
            return category;
        }

        function calculateResult() {
            let category = '';
            let explanation = '';
            let tableNum = '';
            
            if (state.equipmentType === 'vessel' && state.fluidType === 'gas' && state.fluidGroup === 'group2') {
                tableNum = 'Table 1';
                const result = calculateTable1(state.ps, state.v);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'vessel' && state.fluidType === 'gas' && state.fluidGroup === 'group1') {
                tableNum = 'Table 2';
                const result = calculateTable2(state.ps, state.v);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'vessel' && state.fluidType === 'liquid' && state.fluidGroup === 'group2') {
                tableNum = 'Table 3';
                const result = calculateTable3(state.ps, state.v);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'vessel' && state.fluidType === 'liquid' && state.fluidGroup === 'group1') {
                tableNum = 'Table 4';
                const result = calculateTable4(state.ps, state.v);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'piping' && state.fluidType === 'gas' && state.fluidGroup === 'group2') {
                tableNum = 'Table 6';
                const result = calculateTable6(state.ps, state.dn);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'piping' && state.fluidType === 'gas' && state.fluidGroup === 'group1') {
                tableNum = 'Table 7';
                const result = calculateTable7(state.ps, state.dn);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'piping' && state.fluidType === 'liquid' && state.fluidGroup === 'group2') {
                tableNum = 'Table 8';
                const result = calculateTable8(state.ps, state.dn);
                category = result.category;
                explanation = result.explanation;
            } else if (state.equipmentType === 'piping' && state.fluidType === 'liquid' && state.fluidGroup === 'group1') {
                tableNum = 'Table 9';
                const result = calculateTable9(state.ps, state.dn);
                category = result.category;
                explanation = result.explanation;
            }
            
            if (!category) {
                category = 'Erreur de calcul';
                explanation = 'Configuration non reconnue. Veuillez vérifier vos paramètres.';
                tableNum = 'N/A';
                console.error('Configuration non gérée:', state);
            }
            
            if (category !== 'Erreur de calcul') {
                const originalCategory = category;
                category = applySpecialCases(category);
                if (originalCategory !== category) {
                    explanation += ` (Reclassification appliquée suite aux cas particuliers)`;
                }
            }
            
            state.finalCategory = category;
            displayResult(category, explanation, tableNum);

            document.getElementById('step5').classList.add('hidden');
            document.getElementById('step6').classList.remove('hidden');
            state.currentStep = 6;
            saveState();
            updateStepper();
            window.scrollTo(0, 0);

            // Draw zone chart
            const param = state.equipmentType === 'vessel' ? state.v : state.dn;
            drawZoneChart(tableNum, state.ps, param);
        }

        function displayQuickResult(category, explanation, tableNum) {
            const resultCard = document.getElementById('resultCard');
            const resultTitle = document.getElementById('resultTitle');

            resultTitle.textContent = category;
            resultCard.className = 'result-card result-art43';

            document.getElementById('detailType').textContent = state.equipmentType === 'vessel' ? 'Récipient' : 'Tuyauterie';
            document.getElementById('detailFluid').textContent = state.fluidType === 'gas' ? 'Gaz' : 'Liquide';
            document.getElementById('detailGroup').textContent = state.fluidGroup === 'group1' ? 'Groupe 1 (dangereux)' : 'Groupe 2 (non dangereux)';
            document.getElementById('detailPS').textContent = `${state.ps} bar`;
            document.getElementById('detailParamLabel').textContent = '-';
            document.getElementById('detailParam').textContent = 'N/A';
            document.getElementById('detailCalc').textContent = 'N/A';
            document.getElementById('detailTable').textContent = tableNum;
            document.getElementById('explanationText').textContent = explanation;

            // Hide chart for quick results (PS ≤ 0.5)
            document.getElementById('chartSection').classList.add('hidden');
        }

        function displayResult(category, explanation, tableNum) {
            const resultCard = document.getElementById('resultCard');
            const resultTitle = document.getElementById('resultTitle');
            
            resultTitle.textContent = category;
            
            resultCard.className = 'result-card';
            if (category.includes('Non soumis') || category.includes('Article 4§3')) {
                resultCard.classList.add('result-art43');
            } else if (category.includes('Catégorie I')) {
                resultCard.classList.add('result-cat1');
            } else if (category.includes('Catégorie II')) {
                resultCard.classList.add('result-cat2');
            } else if (category.includes('Catégorie III')) {
                resultCard.classList.add('result-cat3');
            } else if (category.includes('Catégorie IV')) {
                resultCard.classList.add('result-cat4');
            } else if (category.includes('Erreur')) {
                resultCard.classList.add('result-error');
            }
            
            document.getElementById('detailType').textContent = state.equipmentType === 'vessel' ? 'Récipient' : 'Tuyauterie';
            document.getElementById('detailFluid').textContent = state.fluidType === 'gas' ? 'Gaz' : 'Liquide';
            document.getElementById('detailGroup').textContent = state.fluidGroup === 'group1' ? 'Groupe 1 (dangereux)' : 'Groupe 2 (non dangereux)';
            document.getElementById('detailPS').textContent = `${state.ps} bar`;
            
            if (state.equipmentType === 'vessel') {
                document.getElementById('detailParamLabel').textContent = 'Volume (V)';
                document.getElementById('detailParam').textContent = `${state.v} litres`;
                document.getElementById('detailCalc').textContent = `PS × V = ${(state.ps * state.v).toFixed(2)} bar.L`;
            } else {
                document.getElementById('detailParamLabel').textContent = 'Dimension Nominale (DN)';
                document.getElementById('detailParam').textContent = `DN ${state.dn}`;
                document.getElementById('detailCalc').textContent = `PS × DN = ${(state.ps * state.dn).toFixed(2)}`;
            }
            
            document.getElementById('detailTable').textContent = tableNum;
            document.getElementById('explanationText').textContent = explanation;
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('Résultat Classification DESP', 20, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Directive 2014/68/UE', 20, 28);
            
            doc.setFontSize(14);
            doc.setTextColor(0);
            doc.text(`Catégorie: ${state.finalCategory || 'N/A'}`, 20, 45);
            
            doc.setFontSize(11);
            let y = 60;
            
            doc.text(`Type d'équipement: ${state.equipmentType === 'vessel' ? 'Récipient' : 'Tuyauterie'}`, 20, y);
            y += 8;
            doc.text(`Type de fluide: ${state.fluidType === 'gas' ? 'Gaz' : 'Liquide'}`, 20, y);
            y += 8;
            doc.text(`Groupe de fluide: ${state.fluidGroup === 'group1' ? 'Groupe 1 (dangereux)' : 'Groupe 2 (non dangereux)'}`, 20, y);
            y += 8;
            doc.text(`Pression (PS): ${state.ps} bar`, 20, y);
            y += 8;
            
            if (state.equipmentType === 'vessel') {
                doc.text(`Volume (V): ${state.v} litres`, 20, y);
                y += 8;
                doc.text(`Calcul: PS × V = ${(state.ps * state.v).toFixed(2)} bar.L`, 20, y);
            } else {
                doc.text(`Dimension Nominale (DN): DN ${state.dn}`, 20, y);
                y += 8;
                doc.text(`Calcul: PS × DN = ${(state.ps * state.dn).toFixed(2)}`, 20, y);
            }
            y += 8;
            
            doc.text(`Tableau appliqué: ${document.getElementById('detailTable').textContent}`, 20, y);
            y += 15;
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Explication:', 20, y);
            y += 6;
            
            const explanation = document.getElementById('explanationText').textContent;
            const splitExplanation = doc.splitTextToSize(explanation, 170);
            doc.text(splitExplanation, 20, y);
            y += (splitExplanation.length * 5) + 10;
            
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(`Document généré le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}`, 20, 280);
            
            doc.save('classification_desp.pdf');
        }

        function resetTool() {
            if (state.currentStep > 1 && !confirm('Êtes-vous sûr de vouloir recommencer ?')) return;

            state.currentStep = 1;
            state.equipmentType = null;
            state.fluidType = null;
            state.fluidGroup = null;
            state.ps = null;
            state.v = null;
            state.dn = null;
            state.specialCases = [];
            state.finalCategory = null;

            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById('step1').classList.remove('hidden');
            document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('input').forEach(input => {
                input.value = '';
                input.classList.remove('error');
            });
            document.querySelectorAll('.input-error').forEach(error => error.classList.remove('visible'));

            localStorage.removeItem('desp_calculator_state');

            updateStepper();
            window.scrollTo(0, 0);
        }

        // =====================================================
        // ZONE CHART - Diagramme de zones réglementaires
        // =====================================================

        const categoryColors = {
            'Non soumis': { fill: '#F3F4F6', stroke: '#9CA3AF', text: '#6B7280' },
            'Article 4§3': { fill: '#E5E7EB', stroke: '#9CA3AF', text: '#6B7280' },
            'Catégorie I': { fill: '#CCFBF1', stroke: '#0D9488', text: '#0F766E' },
            'Catégorie II': { fill: '#FEF3C7', stroke: '#D97706', text: '#92400E' },
            'Catégorie III': { fill: '#FFEDD5', stroke: '#F97316', text: '#C2410C' },
            'Catégorie IV': { fill: '#FEE2E2', stroke: '#DC2626', text: '#991B1B' }
        };

        const chartConfigs = {
            1: { xLabel: 'V (L)', yLabel: 'PS (bar)', xMin: 0.1, xMax: 10000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 1', subtitle: 'Récipients — Gaz — Groupe 2' },
            2: { xLabel: 'V (L)', yLabel: 'PS (bar)', xMin: 0.1, xMax: 10000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 2', subtitle: 'Récipients — Gaz — Groupe 1' },
            3: { xLabel: 'V (L)', yLabel: 'PS (bar)', xMin: 0.1, xMax: 10000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 3', subtitle: 'Récipients — Liquide — Groupe 2' },
            4: { xLabel: 'V (L)', yLabel: 'PS (bar)', xMin: 0.1, xMax: 10000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 4', subtitle: 'Récipients — Liquide — Groupe 1' },
            6: { xLabel: 'DN', yLabel: 'PS (bar)', xMin: 1, xMax: 2000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 6', subtitle: 'Tuyauteries — Gaz — Groupe 2' },
            7: { xLabel: 'DN', yLabel: 'PS (bar)', xMin: 1, xMax: 2000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 7', subtitle: 'Tuyauteries — Gaz — Groupe 1' },
            8: { xLabel: 'DN', yLabel: 'PS (bar)', xMin: 1, xMax: 2000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 8', subtitle: 'Tuyauteries — Liquide — Groupe 2' },
            9: { xLabel: 'DN', yLabel: 'PS (bar)', xMin: 1, xMax: 2000, yMin: 0.5, yMax: 10000,
                 title: 'Tableau 9', subtitle: 'Tuyauteries — Liquide — Groupe 1' }
        };

        function classifyPoint(tableNum, ps, param) {
            switch(tableNum) {
                case 1: return calculateTable1(ps, param).category;
                case 2: return calculateTable2(ps, param).category;
                case 3: return calculateTable3(ps, param).category;
                case 4: return calculateTable4(ps, param).category;
                case 6: return calculateTable6(ps, param).category;
                case 7: return calculateTable7(ps, param).category;
                case 8: return calculateTable8(ps, param).category;
                case 9: return calculateTable9(ps, param).category;
                default: return 'Non soumis';
            }
        }

        function getTableNumber(tableStr) {
            const match = tableStr.match(/\d+/);
            return match ? parseInt(match[0]) : null;
        }

        function drawZoneChart(tableStr, ps, param) {
            const tableNum = getTableNumber(tableStr);
            if (!tableNum || !chartConfigs[tableNum]) {
                document.getElementById('chartSection').classList.add('hidden');
                return;
            }

            document.getElementById('chartSection').classList.remove('hidden');

            const canvas = document.getElementById('zoneChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const config = chartConfigs[tableNum];

            // High-DPI support
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const W = rect.width;
            const H = rect.height;

            const margin = { top: 45, right: 30, bottom: 50, left: 65 };
            const plotW = W - margin.left - margin.right;
            const plotH = H - margin.top - margin.bottom;

            const logXMin = Math.log10(config.xMin);
            const logXMax = Math.log10(config.xMax);
            const logYMin = Math.log10(config.yMin);
            const logYMax = Math.log10(config.yMax);

            function xToPixel(val) {
                if (val <= 0) val = config.xMin;
                return margin.left + (Math.log10(val) - logXMin) / (logXMax - logXMin) * plotW;
            }
            function yToPixel(val) {
                if (val <= 0) val = config.yMin;
                return margin.top + plotH - (Math.log10(val) - logYMin) / (logYMax - logYMin) * plotH;
            }

            // Clear canvas
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, W, H);

            // Fill zones using pixel sampling
            const step = 3;
            for (let px = 0; px < plotW; px += step) {
                for (let py = 0; py < plotH; py += step) {
                    const logX = logXMin + (px / plotW) * (logXMax - logXMin);
                    const logY = logYMin + ((plotH - py) / plotH) * (logYMax - logYMin);
                    const x = Math.pow(10, logX);
                    const y = Math.pow(10, logY);

                    const category = classifyPoint(tableNum, y, x);
                    const color = categoryColors[category];
                    if (color) {
                        ctx.fillStyle = color.fill;
                        ctx.fillRect(margin.left + px, margin.top + py, step, step);
                    }
                }
            }

            // Draw grid lines (log scale)
            ctx.strokeStyle = 'rgba(0,0,0,0.08)';
            ctx.lineWidth = 1;

            for (let exp = Math.ceil(logXMin); exp <= Math.floor(logXMax); exp++) {
                const val = Math.pow(10, exp);
                if (val < config.xMin || val > config.xMax) continue;
                const px = xToPixel(val);
                ctx.beginPath();
                ctx.moveTo(px, margin.top);
                ctx.lineTo(px, margin.top + plotH);
                ctx.stroke();
            }

            for (let exp = Math.ceil(logYMin); exp <= Math.floor(logYMax); exp++) {
                const val = Math.pow(10, exp);
                if (val < config.yMin || val > config.yMax) continue;
                const py = yToPixel(val);
                ctx.beginPath();
                ctx.moveTo(margin.left, py);
                ctx.lineTo(margin.left + plotW, py);
                ctx.stroke();
            }

            // Draw axes
            ctx.strokeStyle = '#111827';
            ctx.lineWidth = 2;

            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, margin.top + plotH);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top + plotH);
            ctx.lineTo(margin.left + plotW, margin.top + plotH);
            ctx.stroke();

            // Axis labels
            ctx.fillStyle = '#111827';
            ctx.font = 'bold 12px -apple-system, sans-serif';

            ctx.save();
            ctx.translate(15, margin.top + plotH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText(config.yLabel, 0, 0);
            ctx.restore();

            ctx.textAlign = 'center';
            ctx.fillText(config.xLabel, margin.left + plotW / 2, H - 10);

            // Axis tick labels
            ctx.font = '10px -apple-system, sans-serif';
            ctx.fillStyle = '#6B7280';

            for (let exp = Math.ceil(logXMin); exp <= Math.floor(logXMax); exp++) {
                const val = Math.pow(10, exp);
                if (val < config.xMin || val > config.xMax) continue;
                const px = xToPixel(val);
                ctx.textAlign = 'center';
                ctx.fillText(val >= 1000 ? (val/1000) + 'k' : val.toString(), px, margin.top + plotH + 18);
            }

            for (let exp = Math.ceil(logYMin); exp <= Math.floor(logYMax); exp++) {
                const val = Math.pow(10, exp);
                if (val < config.yMin || val > config.yMax) continue;
                const py = yToPixel(val);
                ctx.textAlign = 'right';
                ctx.fillText(val >= 1000 ? (val/1000) + 'k' : val.toString(), margin.left - 8, py + 4);
            }

            // Draw marker (red crosshair) if valid
            if (ps > 0 && param > 0 && ps >= config.yMin && param >= config.xMin) {
                const mx = xToPixel(param);
                const my = yToPixel(ps);

                if (mx >= margin.left && mx <= margin.left + plotW &&
                    my >= margin.top && my <= margin.top + plotH) {

                    // Crosshair lines
                    ctx.strokeStyle = '#DC2626';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 3]);

                    ctx.beginPath();
                    ctx.moveTo(mx, margin.top);
                    ctx.lineTo(mx, margin.top + plotH);
                    ctx.stroke();

                    ctx.beginPath();
                    ctx.moveTo(margin.left, my);
                    ctx.lineTo(margin.left + plotW, my);
                    ctx.stroke();

                    ctx.setLineDash([]);

                    // Center dot
                    ctx.fillStyle = '#DC2626';
                    ctx.beginPath();
                    ctx.arc(mx, my, 8, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(mx, my, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Title
            ctx.fillStyle = '#111827';
            ctx.font = 'bold 14px -apple-system, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(config.title + ' — ' + config.subtitle, margin.left, 22);

            // Build legend
            buildChartLegend(tableNum);
        }

        function buildChartLegend(tableNum) {
            const legend = document.getElementById('chartLegend');
            if (!legend) return;

            const config = chartConfigs[tableNum];
            const existingCategories = new Set();

            // Sample to find which categories exist
            for (let logX = Math.log10(config.xMin); logX <= Math.log10(config.xMax); logX += 0.3) {
                for (let logY = Math.log10(config.yMin); logY <= Math.log10(config.yMax); logY += 0.3) {
                    existingCategories.add(classifyPoint(tableNum, Math.pow(10, logY), Math.pow(10, logX)));
                }
            }

            const categories = ['Non soumis', 'Article 4§3', 'Catégorie I', 'Catégorie II', 'Catégorie III', 'Catégorie IV'];

            legend.innerHTML = categories
                .filter(c => existingCategories.has(c))
                .map(c => `<div class="legend-item">
                    <div class="legend-color" style="background:${categoryColors[c].fill};border-color:${categoryColors[c].stroke}"></div>
                    <span>${c}</span>
                </div>`)
                .join('') +
                `<div class="legend-item">
                    <div class="legend-color" style="background:#DC2626;border-radius:50%"></div>
                    <span>Votre équipement</span>
                </div>`;
        }
    </script>

</body>
</html>
